{
  "name": "KasaBot part_2",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -4240,
        1552
      ],
      "id": "3203b1ab-0acf-4dfe-9f33-d7aff466beb9",
      "name": "Telegram Trigger",
      "webhookId": "8d602bd9-a834-43f5-8524-9ae6172bb0d4",
      "credentials": {
        "telegramApi": {
          "id": "GWiNIWfCwEPeHIOg",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * Unify Telegram message & callback into one shape:\n * { chat_id, text, data, is_callback, username, message_id, _raw }\n */\nconst m = $json.message || {};\nconst c = $json.callback_query || {};\nconst isCb = !!c.data;\n\nconst chat_id = isCb ? c.message.chat.id : (m.chat?.id);\nconst text = (m.text || '').trim();\nconst data = isCb ? c.data : '';\nconst message_id = isCb ? c.message.message_id : (m.message_id || null);\nconst username = (m.from?.username || c.from?.username || '') || '';\n\nreturn [{ json: { chat_id, text, data, is_callback: isCb, message_id, username, _raw: $json } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4016,
        1552
      ],
      "id": "4453c738-75d1-4d43-a6b1-204ba26f6cdf",
      "name": "Normalize Event"
    },
    {
      "parameters": {
        "jsCode": "const now = new Date().toISOString();\nreturn [{\n  json: {\n    CustomerId: $json.chat_id,\n    Username: $json.username || '',\n    LastSeenAt: now,\n    FirstSeenAt: now // will only be used on first insert\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3792,
        1552
      ],
      "id": "799f9d2d-8267-4eaa-b398-cc2d0caca0fe",
      "name": "Build Customer Upsert"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 415140327,
          "mode": "list",
          "cachedResultName": "Customers",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=415140327"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -3568,
        1552
      ],
      "id": "e2767341-86e9-42da-9643-5b6c5e39c3f3",
      "name": "GS: Read Customer",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rows = $items('GS: Read Customer').map(i=>i.json);\nconst id = $items('Normalize Event')[0].json.chat_id;\nconst idx = rows.findIndex(r => String(r.CustomerId) === String(id));\nconst existing = idx >= 0 ? rows[idx] : null;\nreturn [{ json: { exists: !!existing, rowIndex: idx+2 /* +2 for header+1-based */, existing } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3344,
        1552
      ],
      "id": "45007a40-ec8a-457f-a8c2-59b2d8c43aad",
      "name": "Find Customer Row"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "701f1773-ee81-4561-97bb-199934d7a86c",
              "leftValue": "={{ $json.exists }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3120,
        1552
      ],
      "id": "8dce540a-685a-41c1-9263-482b3b482cc9",
      "name": "IF Customer Exists?"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 415140327,
          "mode": "list",
          "cachedResultName": "Customers",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=415140327"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "CustomerId": "={{$items('Normalize Event')[0].json.chat_id}}",
            "Username": "={{$items('Normalize Event')[0].json.username}}",
            "LastSeenAt": "={{$now}}"
          },
          "matchingColumns": [
            "CustomerId"
          ],
          "schema": [
            {
              "id": "CustomerId",
              "displayName": "CustomerId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Username",
              "displayName": "Username",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "FirstSeenAt",
              "displayName": "FirstSeenAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastSeenAt",
              "displayName": "LastSeenAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "OrdersCount",
              "displayName": "OrdersCount",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "OptInMarketing",
              "displayName": "OptInMarketing",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ConsentTimestamp",
              "displayName": "ConsentTimestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ConsentSource",
              "displayName": "ConsentSource",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2896,
        1456
      ],
      "id": "8bd88374-ba84-4500-8f8c-0bb96370abaa",
      "name": "Update Customer",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 415140327,
          "mode": "list",
          "cachedResultName": "Customers",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=415140327"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "CustomerId": "={{$items('Normalize Event')[0].json.chat_id}}",
            "Username": "={{$items('Normalize Event')[0].json.username}}",
            "FirstSeenAt": "={{$now}}",
            "LastSeenAt": "={{$now}}",
            "OrdersCount": "0",
            "OptInMarketing": "FALSE"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "CustomerId",
              "displayName": "CustomerId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Username",
              "displayName": "Username",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "FirstSeenAt",
              "displayName": "FirstSeenAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastSeenAt",
              "displayName": "LastSeenAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "OrdersCount",
              "displayName": "OrdersCount",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "OptInMarketing",
              "displayName": "OptInMarketing",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ConsentTimestamp",
              "displayName": "ConsentTimestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ConsentSource",
              "displayName": "ConsentSource",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2896,
        1648
      ],
      "id": "52ce8d35-7f8c-4a1a-9552-ba670c2878d5",
      "name": "Append Customer",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -3792,
        1264
      ],
      "id": "4b538123-6822-48ae-8a26-29e54315527d",
      "name": "GS: Read State",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rows = $items('GS: Read State').map(i=>i.json);\nconst chat_id = $items('Normalize Event')[0].json.chat_id;\nconst idx = rows.findIndex(r => String(r.chat_id) === String(chat_id));\nconst exists = idx >= 0;\nconst rowIndex = idx+2; // header + 1-based\nreturn [{ json: { chat_id, exists, rowIndex } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3344,
        1264
      ],
      "id": "6b20dc6a-1602-4440-a13a-6c4c204de51a",
      "name": "Find/Init State"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "701f1773-ee81-4561-97bb-199934d7a86c",
              "leftValue": "={{ $json.exists }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3120,
        1264
      ],
      "id": "dc9e07fd-8703-48bc-9fc3-7c97fee1253c",
      "name": "IF State Exists?"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{$items('Normalize Event')[0].json.chat_id}}",
            "UpdatedAt": "={{$now}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fulfillment",
              "displayName": "Fulfillment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Zone",
              "displayName": "Zone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "DeliveryFee",
              "displayName": "DeliveryFee",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderUID",
              "displayName": "LastOrderUID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "UpdatedAt",
              "displayName": "UpdatedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CartFrozen",
              "displayName": "CartFrozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2672,
        1264
      ],
      "id": "63a6bf62-d874-4779-a90a-4077793df52a",
      "name": "Append State",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse Callback \u2014 robust\n// - Supports \"ADD|SKU\" and \"KIND|ACTION|SKU\"\n// - Harvests callback query id (cqid) from multiple shapes including _raw\n\nconst u    = $json;\nconst raw  = u._raw ?? u;  // your Normalize Event keeps the original payload here\nconst cb   = raw.callback_query || raw.callbackQuery || raw.callback || null;\nconst msg  = cb?.message ?? raw.message ?? u.message ?? u;\n\n// Sender / chat\nconst from = cb?.from ?? msg?.from ?? {};\nconst chat = msg?.chat ?? {};\n\n// Base fields\nconst chat_id   = String(chat.id ?? u.chat_id ?? from.id ?? '');\nconst username  = (from.username ?? u.username ?? '') || '';\nconst text      = (u.text ?? msg?.text ?? '').trim();\n\n// Callback payload + ID\nconst data = (u.data ?? cb?.data ?? raw.callback_data ?? '').trim();\n\n// Callback query id (various shapes)\nconst cqid =\n  u.cqid ??\n  u.query_id ??\n  u.callback_query_id ??\n  raw?.query_id ??\n  raw?.callback_query_id ??\n  cb?.id ??\n  null;\n\nconst message_id = Number(msg?.message_id ?? u.message_id ?? 0) || 0;\n\n// Parse action/sku\nlet kind   = '';\nlet action = '';\nlet sku    = '';\n\n// \u2705 NEW: mark plain text messages explicitly as 'text'\nif (!data && text) {\n  kind = 'text';\n}\n\nif (data) {\n  const parts = data.split('|');\n  if (parts.length >= 3) {\n    [kind, action, sku] = parts;        // KIND|ACTION|SKU\n  } else if (parts.length === 2) {\n    [action, sku] = parts;               // ACTION|SKU\n    kind = 'BTN';\n  } else {\n    kind = 'BTN';\n    action = parts[0] || '';\n  }\n}\n\n// Optional passthroughs\nconst page = u.page ?? null;\nconst arg  = u.arg  ?? null;\n\n// Mark as callback if we have an id OR callback data\nconst is_callback = Boolean(cqid || data);\n\nreturn [{\n  json: {\n    chat_id, username, text, data,\n    kind, action, sku, page, arg,\n    message_id, cqid, is_callback\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3792,
        1744
      ],
      "id": "18e4872b-e320-4222-b0cd-c5b40f2fee99",
      "name": "Parse Callback"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.text}}",
                    "rightValue": "/menu",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "c0520939-e2c4-49f7-a982-659c58d5d237"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "menu_page"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cf4e7f80-3c66-435a-992e-77c5ca75120c",
                    "leftValue": "={{$json.data}}",
                    "rightValue": "MENU|REFRESH",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "menu_refresh"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cd1d5dc8-eb16-4b33-8bf8-66d786afc36b",
                    "leftValue": "={{$json.kind}}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ed074831-baf8-4b8c-ad34-fc7d71ed2b32",
                    "leftValue": "={{$json.data}}",
                    "rightValue": "ADD|",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "add"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3576c5d6-25bd-4750-a388-1be24d6a9a2e",
                    "leftValue": "={{$json.data}}",
                    "rightValue": "CART|VIEW",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "view"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "572e44a3-ee45-4e99-9031-6f45dbec0a5c",
                    "leftValue": "={{$json.data}}",
                    "rightValue": "CART|CLEAR",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "clear"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b3b45c2a-e899-493c-8680-4ec30f4c4996",
                    "leftValue": "={{$json.data}}",
                    "rightValue": "CART|CHECKOUT",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cart_checkout"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "dbcb4cec-8143-4f67-9827-ef0ea7182c6e",
                    "leftValue": "={{$json.data}}",
                    "rightValue": "DETAILS|",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "details"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "054353b8-618e-4aa0-a936-49a70372c4d5",
                    "leftValue": "={{$json.data}}",
                    "rightValue": "FULFILL|DELIVERY",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "fulfill_delivery"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "017ff0d1-be80-4eca-8714-9c7d5c9e4068",
                    "leftValue": "={{$json.data}}",
                    "rightValue": "FULFILL|PICKUP",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "fulfill_pickup"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "4604fb0e-fc8d-4e71-a431-a4240e2b0fb7",
                    "leftValue": "={{$json.data}}",
                    "rightValue": "ADDR|CHANGE",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "addr_change"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "108389d6-b750-46f0-a63b-174b37b70a0e",
                    "leftValue": "={{ $json.action || ($json.data || '').split('|')[0] }}",
                    "rightValue": "CHECKOUT",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "checkout"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6cdc6605-7d57-42c7-88b9-f0c8407e8519",
                    "leftValue": "={{ $json.action || ($json.data || '').split('|')[0] }}",
                    "rightValue": "PAY",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "pay_instr"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1d2f7344-ace6-41ee-a8c6-cb2d084b6264",
                    "leftValue": "={{$json.data}}",
                    "rightValue": "MENU|OPEN",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "menu_open"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "30b77c40-825e-4e70-a8eb-5eafc83c59e4",
                    "leftValue": "={{$json.data}}",
                    "rightValue": "RESET|START",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reset_start"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "88edfc07-5b3c-4724-b4cc-8bd46eaf9b18",
                    "leftValue": "={{$json.data}}",
                    "rightValue": "HELP|AGENT",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "help_agent"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -848,
        1872
      ],
      "id": "a7fa4fc2-50a8-426c-953e-8e43191b93d9",
      "name": "Action Router"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Menu",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -48,
        1168
      ],
      "id": "7d4b5be9-fdc5-44db-ac51-9e8207e6994d",
      "name": "GS: Read Menu",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * Build Menu Reply (robust, no hard node refs)\n * - Uses $input for rows (from GS: Read Menu)\n * - Safely reads context from Parse Callback (and optionally Default Menu Page)\n * - Item row + separate \u2139\ufe0f row\n */\n\nconst PAGE_SIZE = 6;\nconst CURRENCY = '\u20b5';\nconst HEADER = '\ud83c\udf7d\ufe0f *Today\u2019s Menu*';\nconst MAX_LABEL_CHARS = 40;\n\nconst clean = v => (v ?? '').toString().trim();\nconst isTrue = v => {\n  const s = clean(v).toLowerCase();\n  return s === 'true' || s === '1' || v === true || v === 1;\n};\nconst priceFmt = v => {\n  const n = parseFloat(v);\n  return Number.isFinite(n) ? `${CURRENCY}${n.toFixed(2)}` : `${v}`;\n};\nconst trimLabel = (s, n=MAX_LABEL_CHARS) => {\n  const t = clean(s);\n  return t.length > n ? t.slice(0, n - 1) + '\u2026' : t;\n};\n\n// --- SAFE helper to fetch from a named node if it ran ---\nfunction fromNode(name) {\n  try {\n    const a = $items(name);\n    if (Array.isArray(a) && a.length) return a[0].json;\n  } catch (e) {}\n  return undefined;\n}\n\n// Prefer Parse Callback (always runs), else Default Menu Page, else current $json\nconst ctx = fromNode('Parse Callback') || fromNode('Default Menu Page') || $json;\n\nconst chat_id =\n  ctx?.chat_id ??\n  ctx?.message?.chat?.id ??\n  ctx?.callback_query?.message?.chat?.id;\n\nif (!chat_id) throw new Error('Build Menu Reply: no chat_id found.');\n\nlet page = Math.max(1, Number(ctx?.page || 1));\n\n// Rows come from the previous node (GS: Read Menu) via $input\nconst rows = $input.all().map(i => i.json);\n\n// Filter available\nconst available = rows.filter(r => {\n  if ('Active' in r) return isTrue(r.Active);\n  if ('Available' in r) return isTrue(r.Available);\n  return true;\n});\n\n// Dedupe by SKU\nconst seen = new Set();\nconst unique = [];\nfor (const r of available) {\n  const key = clean(r.SKU) || `${clean(r.Dish)}|${clean(r.Price)}`;\n  if (!seen.has(key)) { seen.add(key); unique.push(r); }\n}\n\n// Group by Category\nconst groups = {};\nfor (const r of unique) {\n  const cat = clean(r.Category) || 'Menu';\n  (groups[cat] ||= []).push(r);\n}\nObject.values(groups).forEach(list => list.sort((a,b) => clean(a.Dish).localeCompare(clean(b.Dish))));\nconst catNames = Object.keys(groups).sort((a,b)=>a.localeCompare(b));\n\nif (!catNames.length) {\n  return [{\n    json: {\n      chat_id,\n      text: `${HEADER}\\n\\n_No dishes available right now. Please check back later._`,\n      parse_mode: 'Markdown',\n      reply_markup: { inline_keyboard: [\n        [{ text: '\ud83d\udd04 Refresh', callback_data: 'MENU|REFRESH' }],\n        [\n          { text: '\ud83e\uddfa View Cart',  callback_data: 'CART|VIEW' },\n          { text: '\u2705 Checkout',   callback_data: 'CART|CHECKOUT' },\n          { text: '\ud83e\uddf9 Clear',      callback_data: 'CART|CLEAR' }\n        ]\n      ]}\n    }\n  }];\n}\n\n// Flatten & paginate\nconst flat = [];\nfor (const cat of catNames) {\n  for (const r of groups[cat]) {\n    const base = `${clean(r.Emoji) ? clean(r.Emoji) + ' ' : ''}${clean(r.Dish) || clean(r.ButtonLabel) || clean(r.SKU)}`;\n    flat.push({\n      sku: clean(r.SKU) || `${clean(r.Dish)}|${clean(r.Price)}`,\n      cat,\n      itemBtn: `${trimLabel(base)} \u2014 ${priceFmt(r.Price)}`,\n      bodyLine: `\u2022 ${base} \u2014 ${priceFmt(r.Price)}`\n    });\n  }\n}\n\nconst totalItems = flat.length;\nconst totalPages = Math.max(1, Math.ceil(totalItems / PAGE_SIZE));\npage = Math.min(Math.max(1, page), totalPages);\nconst start = (page - 1) * PAGE_SIZE;\nconst pageItems = flat.slice(start, start + PAGE_SIZE);\n\n// Message body\nlet text = `${HEADER}\\n\\n`;\nlet lastCat = null;\nfor (const it of pageItems) {\n  if (it.cat !== lastCat) { text += `*${it.cat}*\\n`; lastCat = it.cat; }\n  text += it.bodyLine + '\\n';\n}\ntext += `\\n_Page ${page} of ${totalPages}_\\n_Tap an item to add to cart_`;\n\n// Keyboard: full item row + a separate \u2139\ufe0f row\nconst kb = [];\nfor (const it of pageItems) {\n  kb.push([{ text: it.itemBtn, callback_data: `ADD|${it.sku}` }]);\n  kb.push([{ text: '\u2139\ufe0f',       callback_data: `DETAILS|${it.sku}` }]);\n}\n\n// Nav + utilities\nconst nav = [];\nif (page > 1) nav.push({ text: '\u2b05\ufe0f Prev', callback_data: `MENU|PAGE|${page - 1}` });\nnav.push({ text: '\ud83d\udd04 Refresh', callback_data: 'MENU|REFRESH' });\nif (page < totalPages) nav.push({ text: 'Next \u27a1\ufe0f', callback_data: `MENU|PAGE|${page + 1}` });\nkb.push(nav);\nkb.push([\n  { text: '\ud83e\uddfa View Cart',  callback_data: 'CART|VIEW' },\n  { text: '\u2705 Checkout',   callback_data: 'CART|CHECKOUT' },\n  { text: '\ud83e\uddf9 Clear',      callback_data: 'CART|CLEAR' }\n]);\n\nreturn [{\n  json: { chat_id, text, parse_mode: 'Markdown', reply_markup: { inline_keyboard: kb } }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        176,
        1168
      ],
      "id": "445fb945-c533-4aa9-8fa4-f3f42a05b6c5",
      "name": "Build Menu Reply"
    },
    {
      "parameters": {
        "url": "https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        1168
      ],
      "id": "9ec4b11f-608e-4911-b12c-754522983264",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "jsCode": "return [{ json: { chat_id: $json.chat_id, page: 1 }}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        1120
      ],
      "id": "149b66b3-2e3b-42d1-9338-76fffc4d3b9d",
      "name": "Default Menu Page"
    },
    {
      "parameters": {
        "jsCode": "// Build Dish Details \u2014 sendPhoto (preferred) or sendMessage (fallback)\nconst CURRENCY = '\u20b5';\n\n// Pull sku/chat_id from Parse Callback (fallback to current)\nconst parse = $items('Parse Callback')[0]?.json || $json;\nconst sku = parse.sku || $json.sku;\nconst chat_id = parse.chat_id || $json.chat_id;\n\n// Rows from GS: Read Menu(details) right before this node\nconst rows = $input.all().map(i => i.json);\nconst row = rows.find(r => String(r.SKU) === String(sku));\n\nif (!row) {\n  return [{\n    json: {\n      __endpoint: 'sendMessage',\n      payload: { chat_id, text: 'Item not found.' }\n    }\n  }];\n}\n\n// minimal Markdown escape for Telegram legacy Markdown\nconst esc = s => (s ?? '').toString().replace(/([_*[\\]()~`>#+\\-=|{}.!\\\\])/g, '\\\\$1');\n\nconst price = Number(row.Price) || 0;\nconst dish = `${esc(row.Emoji || '')} ${esc(row.Dish)} \u2014 ${CURRENCY}${price}`;\nconst notes = row.Notes ? `\\n_${esc(row.Notes)}_` : '';\n\nconst caption = `*${dish}*${notes}`;\n\n// Inline keyboard: Add + Back\nconst kb = {\n  inline_keyboard: [\n    [{ text: `\u2795 Add ${esc(row.Dish)}`, callback_data: `ADD|${sku}` }],\n    [{ text: '\u2b05\ufe0f Back', callback_data: 'MENU|REFRESH' }]\n  ]\n};\n\nif (row.PhotoURL) {\n  return [{\n    json: {\n      __endpoint: 'sendPhoto',\n      payload: {\n        chat_id,\n        photo: row.PhotoURL,\n        caption,\n        parse_mode: 'Markdown',\n        reply_markup: kb\n      }\n    }\n  }];\n}\n\n// Fallback without photo\nreturn [{\n  json: {\n    __endpoint: 'sendMessage',\n    payload: {\n      chat_id,\n      text: caption,\n      parse_mode: 'Markdown',\n      reply_markup: kb\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -48,
        2400
      ],
      "id": "1cf2f7a6-1bf0-4fd5-b088-4f5f7f243b62",
      "name": "Build Dish Details"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Menu",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -272,
        2400
      ],
      "id": "81baae7f-c57e-43e2-bce9-808b1547f3fc",
      "name": "GS: Read Menu(details)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/{{$json.__endpoint}}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        176,
        2400
      ],
      "id": "14a44f40-9a5a-489f-b81a-171c35755d39",
      "name": "HTTP Request (details)"
    },
    {
      "parameters": {
        "jsCode": "// Pick Menu Item (by SKU)\n// Mode: Run once for all items\n\n// All menu rows from GS: Read Menu\nconst menu = $input.all().map(i => i.json);\n\n// SKU the user actually tapped\nconst cb = ($items('Parse Callback')?.[0]?.json) || {};\nconst chat_id = String(cb.chat_id || '');\nconst wanted = String(cb.sku || '').trim().toUpperCase();\nif (!chat_id || !wanted) return []; // nothing to do\n\n// Find the matching row in the menu\nconst row = menu.find(r =>\n  String(r.SKU || '').trim().toUpperCase() === wanted\n);\nif (!row) return []; // SKU not in menu\n\nconst price = Number(row.Price || 0);\nconst dish  = row.Dish ?? row.ButtonLabel ?? wanted;\n\n// Emit exactly one new cart line\nreturn [{\n  json: {\n    chat_id,\n    LineId: `${chat_id}|${wanted}`,\n    SKU: wanted,\n    Dish: dish,\n    Price: price,\n    Quantity: 1,\n    LineTotal: price,\n    Frozen: '',\n    CurrentStep: '',\n    PaymentStatus: '',\n    OrderNumber: '',\n    OrderUID: ''\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -16,
        1824
      ],
      "id": "4f120c32-c69d-4891-8c64-4310a3bec1e0",
      "name": "Pick Menu Item (by SKU)"
    },
    {
      "parameters": {
        "jsCode": "// Input: the single \u201cpicked menu item by SKU\u201d (current add) is $json\n// Read all cart rows from the previous GS: Read Cart (add)\nconst rows = $items('GS: Read Cart (add)').map(i => i.json);\n\nconst chatId = String($json.chat_id);\nconst sku    = String($json.SKU);\n\n// \u201cOpen\u201d = NOT frozen, NOT paid, NO order number\nconst isOpen = r =>\n  String(r.chat_id) === chatId &&\n  String(r.SKU)     === sku &&\n  !String(r.Frozen ?? '').toLowerCase().startsWith('t') &&\n  !String(r.PaymentStatus ?? '').toUpperCase().includes('PAID') &&\n  !String(r.OrderNumber ?? '').trim();\n\nconst open = rows.filter(isOpen);\n\n// If we have an existing open row, keep its row_number to update.\n// (If you want newest, sort by Timestamp and take last)\nif (open.length) {\n  const keep = open[open.length - 1];\n  return [{\n    json: {\n      ...keep,\n      exists: true,\n      keep_row_number: keep.row_number   // <-- we\u2019ll match updates on this\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    exists: false,\n    chat_id: chatId,\n    SKU: sku,\n    // Carry through what your downstream nodes need\n    Dish: $json.Dish,\n    Price: $json.Price,\n    Quantity: 1,\n    LineTotal: Number($json.Price || 0)\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        1600
      ],
      "id": "06356824-2c34-4362-8f68-c018862ee621",
      "name": "Find Existing Cart Line"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "701f1773-ee81-4561-97bb-199934d7a86c",
              "leftValue": "={{$json.exists === true && $json.keep_row_number && $json.keep_row_number > 0}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        816,
        1696
      ],
      "id": "5294378a-4c1a-48c5-ac62-b6d8817e6c47",
      "name": "IF Exists?"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Timestamp": "={{$now}}",
            "Quantity": "={{$json.Quantity}}",
            "LineTotal": "={{$json.LineTotal}}",
            "row_number": "={{$json.keep_row_number}}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "Timestamp",
              "displayName": "Timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "LineId",
              "displayName": "LineId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "SKU",
              "displayName": "SKU",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Dish",
              "displayName": "Dish",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Price",
              "displayName": "Price",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "Quantity",
              "displayName": "Quantity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LineTotal",
              "displayName": "LineTotal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "OrderNumber",
              "displayName": "OrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Frozen",
              "displayName": "Frozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Deleted",
              "displayName": "Deleted",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "OrderUID",
              "displayName": "OrderUID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1328,
        1328
      ],
      "id": "2da7f6ba-1565-4319-95a0-107ced12cc18",
      "name": "GS: Update Cart Line",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Timestamp": "={{$now}}",
            "chat_id": "={{$json.chat_id}}",
            "LineId": "={{$json.chat_id}}|{{$json.SKU}}",
            "SKU": "={{$json.SKU}}",
            "Dish": "={{$json.Dish}}",
            "Price": "={{$json.Price}}",
            "Quantity": "={{Number($json.Quantity) || 1}}",
            "LineTotal": "={{ (Number($json.Quantity) || 1) * (Number($json.Price) || 0) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Timestamp",
              "displayName": "Timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LineId",
              "displayName": "LineId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "SKU",
              "displayName": "SKU",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Dish",
              "displayName": "Dish",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Price",
              "displayName": "Price",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Quantity",
              "displayName": "Quantity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LineTotal",
              "displayName": "LineTotal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "OrderNumber",
              "displayName": "OrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Frozen",
              "displayName": "Frozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Deleted",
              "displayName": "Deleted",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "OrderUID",
              "displayName": "OrderUID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1056,
        1728
      ],
      "id": "e5a1863e-051d-49ae-a87c-2cf5b76dcda3",
      "name": "GS: Append Cart Line",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// n8n Code node: Build Cart Summary (old callbacks, new formatting)\n// - Keeps your original callbacks: CART|CHECKOUT, CART|CLEAR, MENU|OPEN\n// - Same cart filtering (this user only, qty>0, not frozen, not PAID)\n// - Just improves the *formatting* to match the screenshot style\n//   \u2022 Dish xQty \u2014 \u20b5PriceEach\n//   Fulfillment hint + Subtotal, Delivery fee, Total\n// - No Telegram code block (so no red background / \u201c<>\u201d)\n\n// ---------- helpers ----------\nconst NBSP = '\\u00A0';\nconst WIDTH = 44;                      // adjust 38\u201350 to tune bubble width\nconst money = v => `\u20b5${Number(v || 0).toFixed(2)}`;\nconst asInt = (v, d = 0) => {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : d;\n};\nconst asNum = (v, d = 0) => {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : d;\n};\n// visible length (strip simple Markdown markers)\nconst visLen = s => String(s).replace(/\\*|_/g, '').length;\nconst padTail = s => s + NBSP.repeat(Math.max(0, WIDTH - visLen(s)));\n\n// ---------- context ----------\nconst ctxItem = $items('Parse Callback')?.[0]?.json ?? {};\nconst chat_id = String(ctxItem.chat_id ?? $json.chat_id ?? '');\nif (!chat_id) {\n  return [{\n    json: { method: 'noop', payload: { reason: 'missing chat_id in Build Cart Summary' } }\n  }];\n}\n\n// ---------- source rows ----------\nconst allRows = $input.all().map(i => i.json);\n\n// Only active, unpaid, unfrozen rows for this user with qty > 0\nconst rows = allRows.filter(r => {\n  if (!r || !r.SKU) return false;\n  if (String(r.chat_id ?? '') !== chat_id) return false;\n  const qty = asInt(r.Quantity, 0);\n  if (qty <= 0) return false;\n  const fr = String(r.Frozen ?? '').trim().toLowerCase();\n  if (fr === 'true' || fr === '1' || fr === 'yes') return false;\n  if (String(r.PaymentStatus ?? '').trim().toUpperCase() === 'PAID') return false;\n  return true;\n});\n\n// ---------- empty state ----------\nif (rows.length === 0) {\n  const text = [\n    '\ud83e\uddfa *Your Cart*',\n    '',\n    '_Your cart is empty._',\n    '',\n    'Tap *View Menu* to add items.'\n  ].join('\\n');\n\n  const keyboard = [\n    [{ text: '\ud83d\udcd6 View Menu', callback_data: 'MENU|OPEN' }]\n  ];\n\n  return [{\n    json: {\n      method: 'sendMessage',\n      payload: {\n        chat_id,\n        text,\n        parse_mode: 'Markdown',\n        reply_markup: { inline_keyboard: keyboard }\n      }\n    }\n  }];\n}\n\n// ---------- build (formatting only) ----------\nlet subtotal = 0;\n\nconst itemLines = rows.map(r => {\n  const dish  = String(r.Dish ?? r.SKU ?? '\u2014');\n  const qty   = asInt(r.Quantity, 0);\n  const price = asNum(r.Price, 0);          // per-item price (as in screenshot)\n  subtotal += qty * price;\n\n  // \u2022 Waakye Set x1 \u2014 \u20b565.00\n  return padTail(`\u2022 ${dish} x${qty} \u2014 ${money(price)}`);\n});\n\nconst deliveryFee = 0;                       // cart view shows 0.00; checkout will compute later\nconst total = subtotal + deliveryFee;\n\n// ---------- keyboard (unchanged: your old callbacks) ----------\nconst keyboard = [\n  [{ text: '\ud83e\uddfe Checkout', callback_data: 'CART|CHECKOUT' }],\n  [\n    { text: '\ud83e\uddf9 Clear cart', callback_data: 'CART|CLEAR' },\n    { text: '\ud83d\udcd6 View Menu',  callback_data: 'MENU|OPEN'  }\n  ]\n];\n\n// ---------- final text ----------\nconst text = [\n  padTail('\ud83e\uddfa *Your Cart*'),\n  '',\n  ...itemLines,\n  '',\n    '',\n  padTail(`*Subtotal:* ${money(subtotal)}`),\n  padTail(`*Delivery fee:* ${money(deliveryFee)}`),\n  padTail(`*Total:* ${money(total)}`)\n].join('\\n');\n\n// ---------- emit ----------\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id,\n      text,\n      parse_mode: 'Markdown',\n      reply_markup: { inline_keyboard: keyboard }\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -48,
        2032
      ],
      "id": "31eb1810-efc2-4584-bad0-f96918b1cd65",
      "name": "Build Cart Summary"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{$env.TG_BOT_TOKEN}}/{{$json.method}}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.payload}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        176,
        2016
      ],
      "id": "639c4d6a-c3a6-44e0-b14f-6ab54aef32ac",
      "name": "Send Cart"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -272,
        2016
      ],
      "id": "47ab3b46-3fd1-423c-8f8a-1d09c4ca8f4d",
      "name": "GS: Read Cart (view)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -272,
        2208
      ],
      "id": "1ce4d2d1-a85a-43e1-a6d2-d1c8870fab4f",
      "name": "GS: Read Cart (clear)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Collect Rows To Delete \u2014 delete ONLY unpaid & unfrozen lines for this user\n\nconst ctx = $items('Parse Callback')?.[0]?.json ?? {};\nconst chat_id = String(ctx.chat_id ?? $json.chat_id ?? '');\n\nconst rows = $input.all().map(i => i.json).filter(r => String(r.chat_id ?? '') === chat_id);\n\n// helpers\nfunction isPaid(v) {\n  const s = String(v ?? '').trim().toLowerCase();\n  // allow common synonyms/flags\n  return ['paid','success','successful','confirmed','complete','completed','true','yes','1'].includes(s);\n}\nfunction isTrue(v) {\n  const s = String(v ?? '').trim().toLowerCase();\n  return ['true','1','yes'].includes(s);\n}\n\n// keep only rows we should delete: NOT paid and NOT frozen\nconst toDelete = rows\n  .filter(r => !isPaid(r.PaymentStatus) && !isTrue(r.Frozen))\n  .map(r => Number(r.row_number))\n  .filter(n => Number.isFinite(n))\n  // delete bottom-up to avoid row-shift\n  .sort((a, b) => b - a);\n\nif (toDelete.length === 0) {\n  // Signal \"nothing to delete\" to your IF node\n  return [{ json: { chat_id, none: true } }];\n}\n\n// emit one item per row_number\nreturn toDelete.map(n => ({ json: { chat_id, row_number: n } }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -48,
        2208
      ],
      "id": "466f4b5d-e5ce-4b31-8e4d-c2c43bdbdc5f",
      "name": "Collect Rows To Delete"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "067a2f22-6c78-475a-8d22-e687b686da63",
              "leftValue": "={{$json.none}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        176,
        2208
      ],
      "id": "6ef54717-b206-4445-b06a-d210f04589da",
      "name": "IF Nothing To Delete?"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        400,
        2352
      ],
      "id": "d7418f37-9102-42e5-bfc9-4f0758299029",
      "name": "Split In Batches (1)"
    },
    {
      "parameters": {
        "operation": "delete",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "startIndex": "={{$json.row_number}}"
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        624,
        2448
      ],
      "id": "53410393-b286-4622-b355-08b6080beea5",
      "name": "GS: Delete Row",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{$items('Parse Callback')[0].json.chat_id}},\n  \"parse_mode\": \"Markdown\",\n  \"text\": \"\ud83e\uddf9 Cart cleared\\u00A0\\u00A0\\u00A0\\u00A0\\u00A0\\u00A0\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [\n      [{ \"text\": \"\ud83c\udf7d\ufe0f Back to Menu\", \"callback_data\": \"MENU|REFRESH\" }],\n      [{ \"text\": \"\ud83e\uddfa View Cart\",     \"callback_data\": \"CART|VIEW\" }]\n    ]\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        848,
        2128
      ],
      "id": "09da1b49-afda-42a4-9f59-a5cf49432860",
      "name": "Send Cleared"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "chat_id",
              "lookupValue": "={{$items('Parse Callback')[0].json.chat_id}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -96,
        1616
      ],
      "id": "3e63cbd7-bca6-4d3c-b221-592d850f7b39",
      "name": "GS: Read Cart (add)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Menu",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=0"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -208,
        1824
      ],
      "id": "558ffe81-20ed-4f09-bd33-c5501e4d3764",
      "name": "GS: Read Menu (add)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "77a6c16e-5c82-4617-a7f6-49cc97372bfd",
              "leftValue": "={{ Array.isArray($json.dupes) && $json.dupes.length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1264,
        1632
      ],
      "id": "f241c647-3144-4547-99fe-dea212a3fc3b",
      "name": "IF Has Dupes?"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1712,
        1632
      ],
      "id": "bf71a5e4-5968-4059-8aab-544358ca9aa1",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{$json.cqid}}",
        "additionalFields": {
          "cache_time": 0,
          "show_alert": false,
          "text": "=\u2705 Added to cart"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -48,
        1440
      ],
      "id": "2b9ae025-ce3c-4f6a-b3de-24dfb5944db5",
      "name": "Ack Added",
      "webhookId": "7d1995d5-c384-454f-adbd-f12db4deea2f",
      "credentials": {
        "telegramApi": {
          "id": "GWiNIWfCwEPeHIOg",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Fan out dupes array to items with row_number\nconst chat_id = $json.chat_id;\nconst dupes = Array.isArray($json.dupes) ? $json.dupes : [];\nif (!dupes.length) return [];\nreturn dupes.map(n => ({ json: { chat_id, row_number: Number(n) } }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1488,
        1632
      ],
      "id": "fac94f9a-b252-4595-89b6-ed6be0a7db23",
      "name": "Make Dupe Items"
    },
    {
      "parameters": {
        "operation": "delete",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "startIndex": "={{$json.row_number}}\n"
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1936,
        1632
      ],
      "id": "face6b7d-4861-442d-95d0-4feb8fe6e727",
      "name": "GS: Delete Row (Row Number = {{$json.row_number}})",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Collapse to exactly one item after the loop (or when nothing to delete)\nreturn [{ json: { chat_id: $items('Parse Callback')[0].json.chat_id } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        2128
      ],
      "id": "587704ca-109e-4f5b-b06a-68793a041568",
      "name": "Carry Chat (clear)"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Build Checkout Summary (Delivery/Pickup aware)\n * Input: items from \"Attach State \u2192 Lines (checkout)\" (cart lines with state fields attached)\n * Output: { method, payload } for Telegram\n */\n\nconst CURRENCY = '\u20b5';\nconst WIDTH = 40;\nconst NBSP = '\\u00A0';\n\nconst money  = n => `${CURRENCY}${(Number(n)||0).toFixed(2)}`;\nconst visLen = s => s.replace(/\\*|_/g,'').length;\nconst pad    = s => s + NBSP.repeat(Math.max(0, WIDTH - visLen(s)));\n\nconst rows = $input.all().map(i => i.json);\n\n// Robust chat_id\nconst chat_id = String(\n  rows[0]?.chat_id ?? rows[0]?.ChatID ?? $json._chat_id ?? $json.chat_id ?? ''\n);\n\nif (!rows.length || !chat_id) {\n  return [{\n    json: {\n      method: 'sendMessage',\n      payload: {\n        chat_id,\n        text: '\ud83e\uddfa Your cart is empty.\\n\\nTap *Menu* to add items.',\n        parse_mode: 'Markdown',\n        reply_markup: { inline_keyboard: [[{ text: '\ud83c\udf7d\ufe0f Back to Menu', callback_data: 'MENU|REFRESH' }]] }\n      }\n    }\n  }];\n}\n\n// State context (now present on each line)\nconst fulfillmentRaw = String(rows[0]?.Fulfillment || '').toLowerCase().trim();\nconst address  = String(rows[0]?.Address  || '').trim();\nconst zone     = String(rows[0]?.Zone     || '').trim();\nconst phone    = String(rows[0]?.Phone    || '').trim();\nconst feeInput = Number(rows[0]?.DeliveryFee ?? 0);\nconst isPickup   = fulfillmentRaw === 'pickup';\nconst isDelivery = fulfillmentRaw === 'delivery';\nconst fee        = isPickup ? 0 : (Number.isFinite(feeInput) ? feeInput : 0);\n\n// Lines\nconst header = pad('\ud83e\uddfa *Your Cart*');\nconst lines = rows.map(r => {\n  const qty   = Number(r.Quantity ?? r.qty ?? 1) || 1;\n  const price = Number(r.Price ?? r.price ?? 0)  || 0;\n  const name  = String(r.Dish ?? r.name ?? r.SKU ?? '').trim();\n  return pad(`\u2022 ${name} x${qty} \u2014 ${money(price)}`);\n});\n\nconst subtotal = rows.reduce((s, r) => {\n  const lt = Number(r.LineTotal ?? r.line_total);\n  if (Number.isFinite(lt) && lt > 0) return s + lt;\n  const q = Number(r.Quantity ?? r.qty ?? 1) || 1;\n  const p = Number(r.Price ?? r.price ?? 0)  || 0;\n  return s + q * p;\n}, 0);\n\nconst fulfillmentLine = isPickup\n  ? '\ud83c\udfea Pickup at counter'\n  : (isDelivery\n     ? `\ud83d\ude9a Delivery${address ? ` to: ${address}` : ''}${zone ? ` (Zone: ${zone})` : ''}`\n     : '\u2014 choose delivery or pickup below \u2014');\n\nconst meta = [\n  pad(`*Fulfillment:* ${fulfillmentLine}`),\n  phone ? pad(`*Phone:* ${phone}`) : null\n].filter(Boolean);\n\nconst foot = [\n  pad(`*Subtotal:* ${money(subtotal)}`),\n  pad(`*Delivery fee:* ${money(fee)}`),\n  pad(`*Total:* ${money(subtotal + fee)}`)\n];\n\nconst text = [header, '', ...lines, '', ...meta, '', ...foot].join('\\n');\n\n// Keyboard\nconst baseRows = [\n  [\n    { text: '\ud83e\uddf9 Clear', callback_data: 'CART|CLEAR' },\n    { text: '\ud83c\udf7d\ufe0f Continue Shopping', callback_data: 'MENU|REFRESH' }\n  ]\n];\n\nlet keyboard;\nif (!isPickup && !isDelivery) {\n  keyboard = [\n    [\n      { text: '\ud83d\ude9a Delivery', callback_data: 'FULFILL|DELIVERY' },\n      { text: '\ud83c\udfea Pickup',   callback_data: 'FULFILL|PICKUP' }\n    ],\n    ...baseRows\n  ];\n} else if (isPickup) {\n  keyboard = [\n    [{ text: '\ud83d\udcb3 Pay now', callback_data: 'PAY' }],\n    [{ text: 'Change to Delivery', callback_data: 'FULFILL|DELIVERY' }],\n    ...baseRows\n  ];\n} else {\n  // delivery\n  if (address) {\n    keyboard = [\n      [{ text: '\ud83d\udcb3 Pay now', callback_data: 'PAY' }],\n      [{ text: 'Change to Pickup', callback_data: 'FULFILL|PICKUP' }],\n      ...baseRows\n    ];\n  } else {\n    keyboard = [\n      [{ text: '\ud83d\udccd Add address', callback_data: 'ADDR|CHANGE' }],\n      [{ text: 'Change to Pickup', callback_data: 'FULFILL|PICKUP' }],\n      ...baseRows\n    ];\n  }\n}\n\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id,\n      text,\n      parse_mode: 'Markdown',\n      reply_markup: { inline_keyboard: keyboard }\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2272,
        720
      ],
      "id": "cd1efa93-3486-484b-b56d-0041dc744fed",
      "name": "Build Checkout Summary"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1824,
        816
      ],
      "id": "749b1733-b1f6-4003-88d6-173518bc962d",
      "name": "GS: Read Cart (checkout)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{$json.chat_id}}",
            "UpdatedAt": "={{$now}}",
            "Fulfillment": "pickup"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fulfillment",
              "displayName": "Fulfillment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Zone",
              "displayName": "Zone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "DeliveryFee",
              "displayName": "DeliveryFee",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderUID",
              "displayName": "LastOrderUID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "UpdatedAt",
              "displayName": "UpdatedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CartFrozen",
              "displayName": "CartFrozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -16,
        3328
      ],
      "id": "2e6e162b-f096-44ac-b3d7-b80c3e994b7c",
      "name": "GS: Append State (pickup)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -48,
        2784
      ],
      "id": "8fa64d81-1cd9-451f-a711-f85884f76794",
      "name": "GS: Read State(delivery)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const isCb = Boolean($json.cqid || $json.is_callback || ($json.data && $json.data.includes('|')));\nreturn isCb ? [{ json: $json }] : [];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        1440
      ],
      "id": "b2912f3e-a2e9-42c2-80a2-7e5975825fff",
      "name": "Ack? (safe)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "chat_id",
              "lookupValue": "={{ String($items('Normalize Event')[0].json.chat_id) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -944,
        592
      ],
      "id": "4037f006-4d26-4f8f-84f7-5bff7fb04a1c",
      "name": "GS: Read State (phone)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Needs Phone? \u2014 fire ONLY on text messages while awaiting phone\nconst evt = $items('Normalize Event')[0].json;   // has chat_id, text, is_callback\nconst chat_id = String(evt.chat_id || '');\nconst rows = $items().map(i => i.json);          // from GS: Read State (phone)\n\n// 1) Ignore button taps/callbacks entirely\nif (evt.is_callback === true) return [];\n\n// 2) Must be a non-empty text message\nconst text = typeof evt.text === 'string' ? evt.text.trim() : '';\nif (!text) return [];\n\n// 3) Find this user's state row\nconst row = rows.find(r => String(r.chat_id || r.ChatID) === chat_id);\nif (!row) return []; // no state row yet\n\n// 4) Only when we are truly waiting for phone\nconst fulfillment = String(row.Fulfillment || '').toLowerCase();\nconst step        = String(row.CurrentStep || '').toLowerCase();\nconst isPickupOrDelivery = (fulfillment === 'pickup' || fulfillment === 'delivery');\n\nconst needsPhone = isPickupOrDelivery && step === 'await_phone';\n\n// 5) Pass row + the text we just received forward\nreturn needsPhone ? [{\n  json: {\n    ...row,\n    _chat_id: chat_id,\n    _text: text\n  }\n}] : [];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -288,
        432
      ],
      "id": "0e0e4c32-5f4f-4c5d-8b94-fdfea1043d59",
      "name": "Needs Phone?"
    },
    {
      "parameters": {
        "jsCode": "// Validate Ghana Phone \u2014 preserve incoming fields\nconst chat_id = $json._chat_id || $json.chat_id;\nconst raw = String($json._text || $json.text || '').replace(/\\s+/g, '');\n\nfunction normGhana(n) {\n  if (/^\\+?233\\d{9}$/.test(n)) {\n    const tail = n.replace(/^\\+?233/, '');\n    return { e164: '+233' + tail, local: '0' + tail };\n  }\n  if (/^0\\d{9}$/.test(n)) {\n    return { e164: '+233' + n.slice(1), local: n };\n  }\n  return null;\n}\n\nconst norm = normGhana(raw);\n\nreturn [{\n  json: {\n    ...$json,                  // << keep Fulfillment, CurrentStep, etc.\n    chat_id,\n    valid: !!norm,\n    phone_local: norm?.local || '',\n    phone_e164: norm?.e164 || ''\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -64,
        432
      ],
      "id": "c46a3ec4-7ac0-46ca-bdf9-ef8521ed4cc4",
      "name": "Validate Ghana Phone"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "0b046203-2730-477f-a9bc-fb6402e4c474",
              "leftValue": "={{$json.valid}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        160,
        432
      ],
      "id": "fab9e019-4d72-4424-b419-d67f67495467",
      "name": "IF \u2014 is phone valid?"
    },
    {
      "parameters": {
        "jsCode": "// Reply: Invalid Phone \u2014 do NOT reference other nodes by name\nconst chat_id = $json._chat_id || $json.chat_id;\n\nconst hint =\n  '\u26a0\ufe0f *That phone number looks invalid.*\\n' +\n  'Send something like `0241234567` or `+233241234567`.';\n\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id,\n      text: hint,\n      parse_mode: 'Markdown',\n      reply_markup: {\n        inline_keyboard: [\n          [{ text: 'Cancel', callback_data: 'MENU|OPEN' }]\n        ]\n      }\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        384,
        544
      ],
      "id": "c74ecc29-0733-4968-83e0-c5cbd44c0c18",
      "name": "Reply: Invalid Phone"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        608,
        544
      ],
      "id": "c68c1090-ec78-4452-bf55-492aaf8dc5bf",
      "name": "HTTP: Send Invalid"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $items('Needs Phone?')[0].json.row_number }}",
            "Phone": "={{$json.phone_local}}",
            "CurrentStep": "await_addr",
            "UpdatedAt": "={{$now}}",
            "chat_id": "={{ $json.chat_id || $json._chat_id || $items('Normalize Event')[0].json.chat_id }}",
            "Fulfillment": "={{$json.Fulfillment}}"
          },
          "matchingColumns": [
            "chat_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fulfillment",
              "displayName": "Fulfillment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Zone",
              "displayName": "Zone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "DeliveryFee",
              "displayName": "DeliveryFee",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderUID",
              "displayName": "LastOrderUID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "UpdatedAt",
              "displayName": "UpdatedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CartFrozen",
              "displayName": "CartFrozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        384,
        352
      ],
      "id": "88dd01dd-6973-4615-af4e-d0c0e91cd9ac",
      "name": "GS: Save Phone",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $items('Needs Phone?')[0].json.row_number }}",
            "CurrentStep": "await_phone",
            "UpdatedAt": "={{$now}}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fulfillment",
              "displayName": "Fulfillment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Zone",
              "displayName": "Zone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "DeliveryFee",
              "displayName": "DeliveryFee",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "UpdatedAt",
              "displayName": "UpdatedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        832,
        544
      ],
      "id": "8ad7309b-d30f-4a28-b12c-a132b0fe2ff4",
      "name": "GS: Keep Await Phone",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Use chat_id from the current item (coming from GS: Save Phone).\nconst chat_id =\n  $json.chat_id ||\n  $json._chat_id ||                 // fallback if you passed it along earlier\n  $items('Normalize Event')[0]?.json?.chat_id;  // last-resort fallback\n\nconst msg =\n  '\u2705 *Phone saved.*\\n' +\n  'Now please *type your delivery area / address*.\\n\\n' +\n  'Tip: use an area keyword if possible (e.g., `osu`, `airport`, `taifa`, `achimota`, `east legon`).';\n\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id,\n      text: msg,\n      parse_mode: 'Markdown'\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        240
      ],
      "id": "88ce2d4d-30b1-4b97-9aa6-82ccb37373bf",
      "name": "Reply: Ask Address"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1184,
        224
      ],
      "id": "f7e9e3d9-ebbb-43fd-8a61-6ee3d2cd4782",
      "name": "HTTP: Send Ask Address"
    },
    {
      "parameters": {
        "jsCode": "// Sets delivery mode and moves user to await_phone.\n// Also clears Zone/Fee (we\u2019ll fill these after address).\nreturn [{\n  json: {\n    chat_id: $json.chat_id,\n    Fulfillment: 'delivery',\n    CurrentStep: 'await_phone',\n    Zone: '',\n    DeliveryFee: '',\n    UpdatedAt: $now\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        2640
      ],
      "id": "f8b5d337-89fc-4bb5-afc1-677584ef533e",
      "name": "Set Delivery Context"
    },
    {
      "parameters": {
        "jsCode": "// Try current item first (from After Update), then fall back safely.\nconst chat_id =\n  $json.chat_id ??\n  $items('Set Delivery Context')[0].json.chat_id ??\n  $items('Parse Callback')[0].json.chat_id;\n\nconst text =\n  '\ud83d\udce6 *Delivery selected.*\\n' +\n  'Please reply with your *phone number* (e.g., `0241234567` or `+233241234567`).';\n\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id,\n      text,\n      parse_mode: 'Markdown',\n      reply_markup: {\n        inline_keyboard: [\n          [{ text: 'Change to Pickup', callback_data: 'FULFILL|PICKUP' }]\n        ]\n      }\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1072,
        2640
      ],
      "id": "3f21d4bd-756f-459b-aa38-fb0bd8b6e77d",
      "name": "Ask For Phone"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1296,
        2640
      ],
      "id": "258eb11e-7341-4bb7-b187-7574e64c6edb",
      "name": "HTTP: Send Ask Phone"
    },
    {
      "parameters": {
        "jsCode": "const isCb = Boolean($json.cqid || $json.is_callback || ($json.data && $json.data.includes('|')));\nreturn isCb ? [{ json: $json }] : [];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        2848
      ],
      "id": "0572a513-422d-4db5-b575-a552adc8dafc",
      "name": "Ack? (safe)1"
    },
    {
      "parameters": {
        "jsCode": "// Has State? \u2014 always runs because it receives an item from Ack? (safe)1.\n// It inspects the parallel GS read results to decide whether a row exists.\n\nconst chatId = String(\n  $json.chat_id ??\n  $items('Parse Callback')[0]?.json?.chat_id ?? ''\n);\n\n// Use the exact node name as it appears in your left panel: GS: Read State(delivery)\nconst rows = ($items('GS: Read State(delivery)') || []).map(i => i.json);\nconst hit  = rows.find(r => String(r.chat_id) === chatId) || null;\n\nreturn [{\n  json: {\n    chat_id: chatId,\n    exists: Boolean(hit),\n    row_number: hit?.row_number ?? null\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        176,
        2848
      ],
      "id": "46f3efd5-d76c-4d70-a74d-9005029fd902",
      "name": "Has State?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "98cb4d98-e5ee-4f0d-bffa-da1526253353",
              "leftValue": "={{$json.exists}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        400,
        2848
      ],
      "id": "afacf433-cbec-43f7-aaf3-8d305c6038ab",
      "name": "IF State Exists?3"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{$json.chat_id}}",
            "UpdatedAt": "={{$json.UpdatedAt}}",
            "CurrentStep": "={{$json.CurrentStep}}",
            "Fulfillment": "={{$json.Fulfillment}}",
            "Zone": "={{$json.Zone}}",
            "DeliveryFee": "={{$json.DeliveryFee}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fulfillment",
              "displayName": "Fulfillment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Zone",
              "displayName": "Zone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "DeliveryFee",
              "displayName": "DeliveryFee",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderUID",
              "displayName": "LastOrderUID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "UpdatedAt",
              "displayName": "UpdatedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CartFrozen",
              "displayName": "CartFrozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        848,
        2944
      ],
      "id": "6c73f70f-e183-4e47-b7ee-5bb6b76e6163",
      "name": "GS: Append State (delivery)1",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Try current item first (from After Update), then fall back safely.\nconst chat_id =\n  $json.chat_id ??\n  $items('Set Delivery Context')[0].json.chat_id ??\n  $items('Parse Callback')[0].json.chat_id;\n\nconst text =\n  '\ud83d\udce6 *Delivery selected.*\\n' +\n  'Please reply with your *phone number* (e.g., `0241234567` or `+233241234567`).';\n\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id,\n      text,\n      parse_mode: 'Markdown',\n      reply_markup: {\n        inline_keyboard: [\n          [{ text: 'Change to Pickup', callback_data: 'FULFILL|PICKUP' }]\n        ]\n      }\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1072,
        2944
      ],
      "id": "bce57bf9-3aec-4910-af80-83461f4e3302",
      "name": "Ask For Phone1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1296,
        2944
      ],
      "id": "d0b4ce61-1976-44cf-ba61-a49c416be728",
      "name": "HTTP: Send Ask Phone1"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    chat_id: $json.chat_id,\n    Fulfillment: 'delivery',\n    CurrentStep: 'await_phone',\n    Zone: '',\n    DeliveryFee: '',\n    UpdatedAt: $now\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        2944
      ],
      "id": "9cc13615-d87e-4198-ae79-81097be0d3c0",
      "name": "Set Delivery Context (create)"
    },
    {
      "parameters": {
        "jsCode": "/** Fire only on text when the user should provide an address. */\nconst rows = ($items('GS: Read State (phone)') || []).map(i => i.json);\nconst evt  = $items('Normalize Event')[0]?.json || {};\nconst is_callback = Boolean(evt.is_callback);   // <-- changed\n\nif (is_callback) return [];\n\nconst chat_id = evt.chat_id;\nconst text    = (evt.text || '').trim();\nif (!text) return [];\n\nconst row = rows.find(r => String(r.chat_id) === String(chat_id));\nif (!row) return [];\n\nconst fulfillment = (row.Fulfillment || '').toLowerCase().trim();\nconst step        = (row.CurrentStep || '').toLowerCase().trim();\n\nconst needsAddr = (fulfillment === 'delivery') && (step === 'await_addr');\nreturn needsAddr ? [{ json: { chat_id, address_text: text } }] : [];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -464,
        848
      ],
      "id": "6cc7c862-deb3-4006-bb6b-93e5575c7746",
      "name": "Needs Address?"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 929019370,
          "mode": "list",
          "cachedResultName": "DeliveryZones",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=929019370"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -48,
        624
      ],
      "id": "96174a17-a7e6-47c6-be49-f244ec9a67a3",
      "name": "GS: Read Zones",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Inputs\nconst chat_id = String($json.chat_id ?? '');\nconst address_raw = String($json.address_text ?? '').trim();\nconst address = address_raw.toLowerCase();\n\n// Zones table from GS: Read Zones (5 items in your run)\nconst rows = ($items('GS: Read Zones') || []).map(i => i.json);\n\n// Build \"available\" (only those marked true)\nconst available = rows\n  .filter(r => String(r.Available).toLowerCase() === 'true')\n  .map(r => String(r.ZoneName || '').trim())\n  .filter(Boolean);\n\n// Find first matching zone by keyword (case-insensitive; comma-separated tokens supported)\nlet hit = null;\nfor (const r of rows) {\n  const kw = String(r.Keyword || '').toLowerCase();\n  if (!kw) continue;\n  const tokens = kw.split(',').map(s => s.trim()).filter(Boolean);\n  if (tokens.some(t => address.includes(t))) {\n    hit = r;\n    break;\n  }\n}\n\n// Always return an array of ONE object\nif (hit) {\n  return [{\n    json: {\n      chat_id,\n      address_text: address_raw,\n      found: true,\n      Zone: String(hit.ZoneName || '').trim(),\n      DeliveryFee: Number(hit.DeliveryFee || 0),\n      available,\n    }\n  }];\n} else {\n  return [{\n    json: {\n      chat_id,\n      address_text: address_raw,\n      found: false,\n      available,\n    }\n  }];\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -64,
        816
      ],
      "id": "f5d94e6d-fa22-40fe-9c2e-27032ae10669",
      "name": "Find Zone"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3180f57e-c6b3-4132-9713-0eb174b9210d",
              "leftValue": "={{ $json.found }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        160,
        816
      ],
      "id": "c7e63817-42bf-408a-850b-2aa80905d593",
      "name": "IF Zone Found?"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Address": "={{ $json.address_text }}",
            "Zone": "={{$json.Zone}}",
            "DeliveryFee": "={{ Number($json.DeliveryFee || 0) }}",
            "CurrentStep": "=await_confirm",
            "UpdatedAt": "={{ $now }}",
            "chat_id": "={{ $json.chat_id }}",
            "LastOrderNumber": "={{$json.OrderNumber}}"
          },
          "matchingColumns": [
            "chat_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fulfillment",
              "displayName": "Fulfillment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Zone",
              "displayName": "Zone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "DeliveryFee",
              "displayName": "DeliveryFee",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderUID",
              "displayName": "LastOrderUID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "UpdatedAt",
              "displayName": "UpdatedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CartFrozen",
              "displayName": "CartFrozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        384,
        736
      ],
      "id": "d53c4a47-5eee-4870-90b2-bc1dc7460f9c",
      "name": "GS: Update State (address)",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Reply: Address OK  \u2014 returns a Telegram sendMessage payload\n\nconst chat_id = $json.chat_id;\n\n// Safe reads with sensible fallbacks\nconst address = String($json.Address ?? '').trim();\nconst zone    = String($json.Zone ?? '').trim();\n\n// Fee: number or string -> pretty, or fallback\nconst rawFee  = $json.DeliveryFee;\nconst feeNum  = (rawFee === '' || rawFee === null || rawFee === undefined)\n  ? null\n  : Number(rawFee);\nconst feeText = (feeNum !== null && !Number.isNaN(feeNum)) ? `\u20b5${feeNum}` : 'to be confirmed';\n\n// Message\nconst text = [\n  '\ud83d\udccd *Address saved*',\n  '',\n  `*Address:* ${address || '\u2014'}`,\n  `*Zone:* ${zone || '\u2014'}`,\n  `*Delivery fee:* ${feeText}`,\n  '',\n  'Use the buttons below, or type a new address to change it.'\n].join('\\n');\n\n// Inline buttons with unique callback_data\nconst reply_markup = {\n  inline_keyboard: [\n    [{ text: '\u2705 Checkout',        callback_data: 'CHECKOUT|START' }],\n    [{ text: '\u270f\ufe0f Change address',  callback_data: 'ADDR|CHANGE' }],\n    [{ text: '\ud83d\udd01 Change to Pickup',callback_data: 'FULFILL|PICKUP' }],\n  ]\n};\n\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id,\n      text,\n      parse_mode: 'Markdown',\n      disable_web_page_preview: true,\n      reply_markup\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        608,
        736
      ],
      "id": "69786074-4d25-4781-aae9-ae423c84a505",
      "name": "Reply: Address OK"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/{{ $json.method }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        832,
        736
      ],
      "id": "c40f5024-a5c2-44be-8590-2f842d02eb9b",
      "name": "HTTP: Send Address OK"
    },
    {
      "parameters": {
        "jsCode": "const addr = ($json.address_text ?? '').trim();\nconst shown = addr ? `*\\\"${addr}\\\"*` : '*that message*';\n\nconst text =\n  `\u274c Sorry, I couldn't match ${shown} to a delivery area.\\n` +\n  (($json.available || []).length ? `We currently deliver to: ${($json.available || []).join(', ')}.\\n` : '') +\n  `Please type your area again (e.g., *Osu*, *Taifa*, *Achimota*, *East Legon*), or type *pickup* to switch to pickup.`;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        384,
        928
      ],
      "id": "8d40a581-a145-4803-a1ba-f49209bf4e0f",
      "name": "Reply: Zone Not Found"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/{{ $json.method }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        608,
        928
      ],
      "id": "6e4c9d56-2463-4249-81c6-da942b500d24",
      "name": "HTTP: Send Zone Not Found"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "CurrentStep": "={{$json.CurrentStep}}",
            "Fulfillment": "={{$json.Fulfillment}}",
            "UpdatedAt": "={{$json.UpdatedAt}}"
          },
          "matchingColumns": [
            "chat_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fulfillment",
              "displayName": "Fulfillment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Zone",
              "displayName": "Zone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "DeliveryFee",
              "displayName": "DeliveryFee",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "UpdatedAt",
              "displayName": "UpdatedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        848,
        2640
      ],
      "id": "ff93214f-039d-4b5d-b132-d2734e6a04e9",
      "name": "GS: Update State (delivery)1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * Set user to await_addr so the next TEXT message will be treated as a new address.\n * Also clear Zone/Fee so they\u2019ll be recomputed.\n */\nreturn [{\n  json: {\n    chat_id: $json.chat_id,        // comes from Parse Callback \u2192 Action Router\n    CurrentStep: 'await_addr',\n    Zone: '',\n    DeliveryFee: '',\n    UpdatedAt: $now\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -48,
        3472
      ],
      "id": "cf44de71-c651-4145-aa5b-f8bbb1d2de9c",
      "name": "Set Await Address (code)"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{$json.chat_id}}",
            "CurrentStep": "={{$json.CurrentStep}}",
            "Zone": "={{$json.Zone}}",
            "DeliveryFee": "={{$json.DeliveryFee}}",
            "UpdatedAt": "={{$json.UpdatedAt}}"
          },
          "matchingColumns": [
            "chat_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fulfillment",
              "displayName": "Fulfillment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Zone",
              "displayName": "Zone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "DeliveryFee",
              "displayName": "DeliveryFee",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "UpdatedAt",
              "displayName": "UpdatedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        176,
        3472
      ],
      "id": "8e8a0bbc-9ff8-4519-b8bd-303f20fc5d2f",
      "name": "Update row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const isCb = Boolean($json.cqid || $json.is_callback || ($json.data && $json.data.includes('|')));\nreturn isCb ? [{ json: $json }] : [];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        3472
      ],
      "id": "a6cca3e3-811d-451b-9db2-d9f471abd8ef",
      "name": "Ack? (safe)2"
    },
    {
      "parameters": {
        "jsCode": "const isCb = Boolean($json.cqid || $json.is_callback || ($json.data && $json.data.includes('|')));\nreturn isCb ? [{ json: $json }] : [];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        3760
      ],
      "id": "0dc339d8-e1b0-4339-89d3-3a1ac6035c01",
      "name": "Ack? (safe)3"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -48,
        3664
      ],
      "id": "9497cb51-44a9-4075-88a5-82a6aad7dcc7",
      "name": "GS: Read Cart",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// filter Cart \u2014 keep ONLY active, unpaid, unfrozen lines for THIS user (qty > 0)\n\n// get current chat_id from Parse Callback (or current item)\nconst ctx = $items('Parse Callback')?.[0]?.json ?? {};\nconst chat_id = String(ctx.chat_id ?? $json.chat_id ?? '');\n\n// helpers\nconst asInt = (v, d = 0) => {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : d;\n};\nconst isTrue = (v) => ['true','1','yes'].includes(String(v ?? '').trim().toLowerCase());\nconst isPaid = (v) => ['paid','success','successful','confirmed','complete','completed','true','yes','1']\n  .includes(String(v ?? '').trim().toLowerCase());\n\n// source rows from GS: Read Cart (previous node)\nconst rows = $input.all().map(i => i.json);\n\n// apply filters\nconst active = rows.filter(r => {\n  if (!r || !r.SKU) return false;                  // must be a cart line\n  if (String(r.chat_id ?? '') !== chat_id) return false; // this user only\n  if (asInt(r.Quantity, 0) <= 0) return false;     // qty > 0\n  if (isTrue(r.Frozen)) return false;              // drop frozen\n  if (isPaid(r.PaymentStatus)) return false;       // drop paid\n  return true;\n});\n\n// emit same shape items for downstream nodes\nreturn active.map(r => ({ json: r }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        176,
        3664
      ],
      "id": "82029028-5b38-4307-8d05-b21c8b028854",
      "name": "filter Cart"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Build a pre-payment checkout summary (Markdown) in user's existing style.\n * Accepts cart rows and one state row in ANY order.\n * Expects columns in cart: Dish, SKU, Price, Quantity, LineTotal\n * Expects state: Fulfillment, Zone, DeliveryFee\n */\n\nconst CURRENCY = '\u00a2'; // keep your Ghana cedi symbol formatting\nconst HEADER = '\ud83e\uddfe *Checkout*';\nconst EMPTY = 'Your cart is empty.\\n\\nTap *Menu* to add items.';\n\n// ---- helpers ----\nconst clean = v => (v ?? '').toString().trim();\nconst num = v => {\n  const n = parseFloat(v);\n  return Number.isFinite(n) ? n : 0;\n};\nconst money = v => `${CURRENCY}${(Math.round(num(v) * 100) / 100).toString()}`;\n\n// ---- collect inputs (cart + state) in any order ----\nlet cart = [];\nlet state = {};\n\nfor (const item of $input.all()) {\n  const j = item.json || {};\n  // Heuristic: state row usually has Fulfillment and Zone fields\n  if ('Fulfillment' in j || 'Zone' in j || 'DeliveryFee' in j) {\n    // choose the first non-empty state row\n    if (!state.chat_id && j.chat_id) state = j;\n  } else {\n    cart.push(j);\n  }\n}\n\n// If the state read returned an array (some n8n versions), normalize:\nif (Array.isArray(state) && state.length) state = state[0];\n\n// Fallback to any upstream chat id\nconst chat_id = $json.chat_id\n  ?? state.chat_id\n  ?? $items(0)[0]?.json?.chat_id\n  ?? $items(1)[0]?.json?.chat_id;\n\n// ---- compute sums ----\nlet lines = [];\nlet subtotal = 0;\n\nfor (const row of cart) {\n  const dish = clean(row.Dish || row.Item || row.Name);\n  const qty  = num(row.Quantity);\n  const price = num(row.Price);\n  const line = num(row.LineTotal) || qty * price;\n\n  if (!dish || qty <= 0) continue;\n\n  subtotal += line;\n  lines.push(`\u2022 ${dish}  x${qty}  \u2014  ${money(line)}`);\n}\n\nconst hasItems = lines.length > 0;\n\n// delivery context\nconst fulfillment = clean(state.Fulfillment).toLowerCase(); // 'delivery' | 'pickup'\nconst zone = clean(state.Zone);\nconst deliveryFee = num(state.DeliveryFee);\nconst isDelivery = fulfillment === 'delivery';\n\nconst feeLine =\n  isDelivery\n    ? (deliveryFee > 0\n        ? `\\nDelivery fee (${zone || '\u2014'}): *${money(deliveryFee)}*`\n        : `\\nDelivery fee: *\u2014*`)\n    : '';\n\nconst total = subtotal + (isDelivery ? deliveryFee : 0);\n\n// ---- message text ----\nlet text;\nif (!hasItems) {\n  text = EMPTY;\n} else {\n  text =\n    `${HEADER}\\n\\n` +\n    `${lines.join('\\n')}\\n\\n` +\n    `Subtotal: *${money(subtotal)}*` +\n    `${feeLine}` +\n    `\\nTotal: *${money(total)}*` +\n    `\\n\\nFulfillment: *${fulfillment || '\u2014'}*` +\n    (isDelivery && !zone ? `\\nZone: *\u2014* (tap \u201c\u270f\ufe0f Change address\u201d)` : '');\n}\n\n// ---- inline keyboard (keep your existing callback styles) ----\nconst keyboard = hasItems\n  ? [\n      [\n        { text: '\u2705 Proceed to pay', callback_data: 'PAY|INSTR' }\n      ],\n      [\n        { text: '\u270f\ufe0f Change address', callback_data: 'ADDR|CHANGE' },\n        { text: '\ud83d\ude97 Change to Pickup', callback_data: 'FULFILL|PICKUP' }\n      ],\n      [\n        { text: '\ud83e\uddf9 Clear cart', callback_data: 'CART|CLEAR' },\n        { text: '\ud83d\udcdc Menu', callback_data: 'MENU' }\n      ]\n    ]\n  : [\n      [\n        { text: '\ud83d\udcdc Menu', callback_data: 'MENU' }\n      ]\n    ];\n\n// ---- emit Telegram payload ----\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id,\n      text,\n      parse_mode: 'Markdown',\n      reply_markup: { inline_keyboard: keyboard }\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        3760
      ],
      "id": "7c29d38d-4be4-4315-8ec7-f8713942ace6",
      "name": "Build Checkout Summary (code)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        848,
        3760
      ],
      "id": "eb4625ab-788f-40bd-b73b-b8c4450dc059",
      "name": "HTTP: Send Checkout Summary"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "chat_id",
              "lookupValue": "={{$json.chat_id}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        176,
        3856
      ],
      "id": "362c32a8-5d52-466d-b010-2bc82939726a",
      "name": "GS: Read State1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        400,
        3760
      ],
      "id": "89166aa2-f75e-439b-a735-0b568aa8b73b",
      "name": "Join: Cart+State"
    },
    {
      "parameters": {
        "jsCode": "const isCb = Boolean($json.cqid || $json.is_callback || ($json.data && $json.data.includes('|')));\nreturn isCb ? [{ json: $json }] : [];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        4176
      ],
      "id": "26641e16-10b3-4b6d-a2b7-6eea3973034d",
      "name": "Ack?(safe)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "chat_id",
              "lookupValue": "={{$json.chat_id}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -48,
        4080
      ],
      "id": "e8fbffb5-7ebc-47b7-bde1-a31225550db8",
      "name": "GS: Read Cart1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "chat_id",
              "lookupValue": "={{$json.chat_id}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        336,
        4336
      ],
      "id": "925a355d-b609-4550-8dc1-ec8b8d818293",
      "name": "GS: Read State (UserStates)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Expect input items from \"Join: Cart + OrderNo\" (one per cart row)\n// Each should have row_number and OrderNumber\nconst out = [];\nfor (const it of $input.all()) {\n  const j = it.json || {};\n  if (j.row_number != null && j.OrderNumber) {\n    out.push({ json: { row_number: j.row_number, OrderNumber: j.OrderNumber } });\n  }\n}\n// If nothing matched, don't break downstream\u2014just emit nothing\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1488,
        4080
      ],
      "id": "005fb339-87ff-4bdc-9b89-1c582e2d23fd",
      "name": "Prepare Line Updates"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code node: Build Payment Instructions (FULL VERSION)\n// - Fixes subtotal=0 (SKU-first split)\n// - Adds \"Back to checkout\" button\n// - Strong visual emphasis on TOTAL\n// -----------------------------------------------------------\n\nconst CONSTANTS = {\n  BrandName:  'Sefake Kitchen',\n  MomoName:   'Sefake Kitchen',\n  MomoNumber: '024XXXXXXX',                // <-- your MoMo number\n  BACK_TO_CHECKOUT_DATA: 'CART|CHECKOUT',  // <-- router action to return to checkout\n};\n\n// ---------- helpers ----------\nconst num = (v, d = 0) => {\n  const s = String(v ?? '').replace(/[, ]/g, '');\n  const n = Number(s);\n  return Number.isFinite(n) ? n : d;\n};\nconst fmt  = (v) => `\u00a2${Number(v).toLocaleString('en-GH', { maximumFractionDigits: 2 })}`;\nconst safe = (s) => (s == null ? '' : String(s).trim());\nconst shortRef = (ref) => (ref ? String(ref).trim() : '');\n\n// ---------- collect all incoming rows ----------\nconst rows = items.map(it => it.json);\n\n// ---------- split into cart vs state/order (SKU-first to avoid misclassifying cart rows) ----------\nlet cart = [];\nlet order = {};\nfor (const j of rows) {\n  const isCartish  = !!(j.SKU || j.Dish || j.Item || j.Name);\n  const isStateish = ('Fulfillment' in j) || ('DeliveryFee' in j) || ('Zone' in j) || ('chat_id' in j);\n\n  if (isCartish) {\n    cart.push(j);\n    if (!order.OrderNumber && j.OrderNumber) order.OrderNumber = safe(j.OrderNumber);\n    if (!order.chat_id    && j.chat_id)     order.chat_id    = j.chat_id;\n  } else if (isStateish) {\n    if (!order.chat_id && j.chat_id) order = { ...j, ...order };\n    else order = { ...order, ...j };\n    if (!order.OrderNumber && j.OrderNumber) order.OrderNumber = safe(j.OrderNumber);\n  } else if (j.OrderNumber && !order.OrderNumber) {\n    order.OrderNumber = safe(j.OrderNumber);\n  }\n}\n\n// ---------- constants (prefer sheet overrides where present) ----------\nconst BrandName   = safe(order.BrandName)   || CONSTANTS.BrandName;\nconst MomoName    = safe(order.MomoName)    || CONSTANTS.MomoName;\nconst MomoNumber  = safe(order.MomoNumber)  || CONSTANTS.MomoNumber;\nconst BACK_CB     = CONSTANTS.BACK_TO_CHECKOUT_DATA;\n\n// ---------- compute money ----------\nlet subtotal = 0;\nfor (const line of cart) {\n  const lt   = num(line.LineTotal);\n  const p    = num(line.Price);\n  const qty  = num(line.Quantity, 1);\n  subtotal  += (Number.isFinite(lt) && lt > 0) ? lt : (p * qty);\n}\nconst deliveryFee = num(order.DeliveryFee, 0);\nconst total       = subtotal + deliveryFee;\n\n// ---------- derive reference & chat ----------\nconst refCode = shortRef(order.OrderNumber || order.OrderUID || order.OrderId || '');\nconst chat_id = order.chat_id || order.ChatID || order.chatid || order.user_id;\n\n// ---------- build message (make TOTAL unmissable) ----------\nconst headline = '\ud83d\udcb3 *Payment for Order*' + (refCode ? `\\nRef: *${refCode}*` : '');\nconst breakdown = [\n  `Subtotal: *${fmt(subtotal)}*`,\n  ...(deliveryFee > 0 ? [`Delivery fee: *${fmt(deliveryFee)}*`] : []),\n].join('\\n');\n\nconst totalPanel = [\n  '\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501',\n  `\ud83d\udca5 *TOTAL TO PAY: ${fmt(total)}*`,\n  '\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501',\n].join('\\n');\n\nlet lines = [];\nlines.push(headline);\nlines.push('');\nlines.push(breakdown);\nlines.push(totalPanel);\nlines.push('');\nlines.push('\ud83d\udfe1 *Very important*');\nif (refCode) {\n  lines.push('When paying, type this in the *Reference/Reason/Message* field:');\n  lines.push(`\ud83e\uddfe *${refCode}*`);\n}\nlines.push('This lets our admin match your payment quickly.');\nlines.push('');\nlines.push('\ud83d\udcf2 *MoMo Details*');\nlines.push(`\u2022 Number: ${MomoNumber}`);\nlines.push(`\u2022 Name: ${MomoName}`);\nlines.push('');\nlines.push('After paying, tap *I have paid*. Or tap *Back to checkout* to review your order.');\nconst text = lines.join('\\n');\n\n// ---------- inline keyboard ----------\nconst confirmCb = `PAY|CONFIRM|${refCode || 'UNKNOWN'}`;\nconst reply_markup = {\n  inline_keyboard: [\n    [{ text: '\u2705 I have paid',      callback_data: confirmCb }],\n    [{ text: '\u2b05\ufe0f Back to checkout', callback_data: BACK_CB }],\n  ],\n};\n\n// ---------- return Telegram payload ----------\nreturn [\n  {\n    json: {\n      method: 'sendMessage',\n      payload: {\n        chat_id,\n        text,\n        parse_mode: 'Markdown',\n        reply_markup,\n      },\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1712,
        4320
      ],
      "id": "d3c91669-c554-42bb-bd84-60144964554f",
      "name": "Build Payment Instructions"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1936,
        4320
      ],
      "id": "163e4065-1dd4-4d39-9f14-ac31f2516deb",
      "name": "HTTP: Send Payment Instructions"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{$json.chat_id}}",
            "CurrentStep": "=await_payment",
            "LastOrderNumber": "={{$json.OrderNumber}}",
            "UpdatedAt": "={{$now}}",
            "LastOrderUID": "={{$json.OrderNumber}}"
          },
          "matchingColumns": [
            "chat_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fulfillment",
              "displayName": "Fulfillment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Zone",
              "displayName": "Zone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "DeliveryFee",
              "displayName": "DeliveryFee",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderUID",
              "displayName": "LastOrderUID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "UpdatedAt",
              "displayName": "UpdatedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1568,
        3760
      ],
      "id": "44947530-c6e7-4545-88d3-e2c01131fc60",
      "name": "GS: Update State (await_payment + LastOrderNumber)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Input: all active cart lines (current cart)\n// Output: one meta object with { OrderNumber, OrderUID }\n\nconst items = $input.all().map(i => i.json);\n\n// Helper: treat TRUE/'TRUE' as true\nconst isTrue = v => v === true || String(v).toLowerCase() === 'true';\n\n// 1) If any UNFROZEN line already has an OrderNumber, reuse it (same active cart)\nconst existing = items.find(l => !isTrue(l.Frozen) && String(l.OrderNumber || '').trim() !== '');\nif (existing) {\n  return [{ json: { OrderNumber: String(existing.OrderNumber), OrderUID: String(existing.OrderNumber) } }];\n}\n\n// 2) Otherwise mint a fresh short, low-collision ref\nconst chatId = (items[0]?.chat_id ?? '') + '';\nfunction makeRef(chatIdStr) {\n  const t = Date.now(); // ms\n  // 4 chars of rolling time + 3 chars of a tiny hash of (chat_id + t) => 7 chars total\n  const time4 = (t % (36 ** 4)).toString(36).toUpperCase().padStart(4, '0');\n  let h = 0; const s = chatIdStr + '|' + t;\n  for (let i = 0; i < s.length; i++) h = ((h * 31) + s.charCodeAt(i)) >>> 0;\n  const tail3 = (h % (36 ** 3)).toString(36).toUpperCase().padStart(3, '0');\n  return `SFK-${time4}${tail3}`; // e.g., SFK-7Q9KX1J (7 after dash)\n}\n\nconst ref = makeRef(chatId);\nreturn [{ json: { OrderNumber: ref, OrderUID: ref } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        560,
        4432
      ],
      "id": "3f55b4a8-cb91-40ce-9ef4-903488bda44c",
      "name": "Ensure Order Number"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{$json.row_number}}",
            "OrderNumber": "={{$json.OrderNumber}}",
            "PaymentStatus": "PENDING"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "Timestamp",
              "displayName": "Timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LineId",
              "displayName": "LineId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "SKU",
              "displayName": "SKU",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Dish",
              "displayName": "Dish",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Price",
              "displayName": "Price",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Quantity",
              "displayName": "Quantity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LineTotal",
              "displayName": "LineTotal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "OrderNumber",
              "displayName": "OrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Frozen",
              "displayName": "Frozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1712,
        4080
      ],
      "id": "f606ba8f-dc0b-4955-858f-6eea47d9f791",
      "name": "GS: Update Lines (Orders)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// filter Cart \u2014 keep ONLY active, unpaid, unfrozen lines for THIS user (qty > 0)\n\n// get current chat_id from Parse Callback (or current item)\nconst ctx = $items('Parse Callback')?.[0]?.json ?? {};\nconst chat_id = String(ctx.chat_id ?? $json.chat_id ?? '');\n\n// helpers\nconst asInt = (v, d = 0) => {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : d;\n};\nconst isTrue = (v) => ['true','1','yes'].includes(String(v ?? '').trim().toLowerCase());\nconst isPaid = (v) => ['paid','success','successful','confirmed','complete','completed','true','yes','1']\n  .includes(String(v ?? '').trim().toLowerCase());\n\n// source rows from GS: Read Cart (previous node)\nconst rows = $input.all().map(i => i.json);\n\n// apply filters\nconst active = rows.filter(r => {\n  if (!r || !r.SKU) return false;                  // must be a cart line\n  if (String(r.chat_id ?? '') !== chat_id) return false; // this user only\n  if (asInt(r.Quantity, 0) <= 0) return false;     // qty > 0\n  if (isTrue(r.Frozen)) return false;              // drop frozen\n  if (isPaid(r.PaymentStatus)) return false;       // drop paid\n  return true;\n});\n\n// emit same shape items for downstream nodes\nreturn active.map(r => ({ json: r }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        176,
        4080
      ],
      "id": "70d4421f-a2f7-4a95-8cf8-47a875493322",
      "name": "filter Cart (qty>0)"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        704,
        4080
      ],
      "id": "e6f80668-f5c2-4dc1-9619-8314bbfd83df",
      "name": "Join: Cart + OrderNo"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1488,
        4320
      ],
      "id": "99c20321-951d-41db-a945-3728e3d36bd9",
      "name": "Join: PayCard Inputs"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.data }}",
                    "rightValue": "PAY|CONFIRM",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "2accc4da-cda9-4d0f-ba1f-43e8f7a549b8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "confirm"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3808,
        2784
      ],
      "id": "92bf68bf-2fc1-4dc9-ac38-a9fa56fde241",
      "name": "PAY|CONFIRM?"
    },
    {
      "parameters": {
        "jsCode": "// Extracts PAY|CONFIRM|REF from callback data and keeps chat context\nconst data = String($json.data || '');\nconst parts = data.split('|'); // [\"PAY\",\"CONFIRM\",\"REF\"]\nconst ref = (parts[2] || '').trim();\n\nreturn [{\n  json: {\n    chat_id: String($json.chat_id || ''),\n    ref,\n    message_id: $json.message_id || null,\n    cqid: $json.cqid || null,   // callback_query_id for answerCallbackQuery\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3168,
        2784
      ],
      "id": "3484b4c3-92db-41c5-878a-47f95bb6f545",
      "name": "Extract PAY|CONFIRM Ref"
    },
    {
      "parameters": {
        "jsCode": "// Immediately answer the callback to stop the spinner\nreturn [{\n  json: {\n    method: 'answerCallbackQuery',\n    payload: {\n      callback_query_id: $json.cqid,\n      text: 'Thanks! Checking payment\u2026',\n      show_alert: false\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2944,
        2976
      ],
      "id": "e3edbea2-95f6-40fc-934f-4e8e9adac1c0",
      "name": "Answer Callback (immediate)"
    },
    {
      "parameters": {
        "jsCode": "const chat_id = $items('Extract PAY|CONFIRM Ref')[0].json.chat_id;\nconst ref = $items('Extract PAY|CONFIRM Ref')[0].json.ref;\n\nconst text = [\n  '\u26a0\ufe0f *Payment reference not recognised*',\n  ref ? `Ref: *${ref}*` : '',\n  '',\n  'Please double-check and try again.',\n  'If you just paid, wait a few seconds and tap *I have paid* again.'\n].filter(Boolean).join('\\n');\n\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id,\n      text,\n      parse_mode: 'Markdown',\n      reply_markup: {\n        inline_keyboard: [[\n          { text: '\u2b05\ufe0f Back to checkout', callback_data: 'CHK|REVIEW' }\n        ]]\n      }\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1600,
        2688
      ],
      "id": "1dd02051-64b7-41a1-a087-b5683872f058",
      "name": "Reply: Ref Not Found"
    },
    {
      "parameters": {
        "jsCode": "// Build a simple \"processing payment\" message for the customer\nconst ref = $json.ref || 'UNKNOWN';\nconst chat_id = $json.chat_id;\n\nconst text = [\n  '\ud83d\udcb3 *Processing your payment...*',\n  `Ref: *${ref}*`,\n  '',\n  '_Please wait a moment while we confirm your payment._'\n].join('\\n');\n\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id,\n      text,\n      parse_mode: 'Markdown',\n      reply_markup: {\n        inline_keyboard: [\n          [{ text: '\u2b05\ufe0f Back to checkout', callback_data: 'CHK|REVIEW' }]\n        ]\n      }\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2944,
        2784
      ],
      "id": "25223d7e-a10f-4096-bf1f-512982604e8c",
      "name": "Build Customer Processing Message"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b187d5db-ac97-499b-b3ae-ccdee5719f0a",
              "leftValue": "={{ $json.OrderNumber }}",
              "rightValue": "={{ $items(\"Extract PAY|CONFIRM Ref\")[0].json.ref }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "d18b778a-97d8-4bcc-a0c0-b4cda3fef181",
              "leftValue": "={{ String($json.chat_id) }}",
              "rightValue": "={{ String($items(\"Extract PAY|CONFIRM Ref\")[0].json.chat_id) }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2720,
        2592
      ],
      "id": "95d617c5-f55b-4e00-9f30-4f74bd35d12c",
      "name": "IF: OrderNumber matches ref (IF)"
    },
    {
      "parameters": {
        "jsCode": "// Aggregate all rows that passed the IF (these are the actual cart lines)\nconst refCtx   = $items('Extract PAY|CONFIRM Ref')[0].json;\nconst chat_id  = String(refCtx.chat_id || '');\nconst ref      = String(refCtx.ref || '');\n\nconst lines = $input.all().map(i => i.json);\n\n// Compute money\nconst money = n => `\u20b5${(Number(n)||0).toFixed(2)}`;\nlet subtotal = 0;\nfor (const l of lines) {\n  const lt = Number(l.LineTotal || 0);\n  const p  = Number(l.Price || 0);\n  const q  = Number(l.Quantity || 1);\n  subtotal += lt > 0 ? lt : (p * q);\n}\n\n// Delivery fee (if present on any line; else 0)\nconst deliveryFee = Number((lines.find(l => l.DeliveryFee != null)?.DeliveryFee) || 0);\nconst total = subtotal + deliveryFee;\n\n// Compact item lines (for kitchen msg later)\nconst itemLines = lines.map(l => `\u2022 ${l.Dish || l.SKU} x${l.Quantity} \u2014 ${money(l.LineTotal || (l.Price||0)*(l.Quantity||1))}`);\n\nreturn [{\n  json: { chat_id, ref, lines, subtotal, deliveryFee, total, itemLines }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2496,
        2592
      ],
      "id": "fbe9a747-1d48-455e-b891-8496feb21d90",
      "name": "Aggregate Lines & Totals"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2048,
        2512
      ],
      "id": "760d2506-7976-4412-b7a8-3e6b401dda95",
      "name": "GS: Read Orders (by ref)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * Enrich the aggregated cart with DeliveryFee (and Fulfillment) from Orders.\n * Matches by (OrderNumber OR LastOrderNumber) AND chat_id.\n */\n\nfunction normalizeRows(arr) {\n  const rows = [];\n  for (const it of arr) {\n    const j = it.json || {};\n    if (Array.isArray(j.data)) rows.push(...j.data);\n    else rows.push(j);\n  }\n  return rows;\n}\n\n// Aggregated payload from previous step\nconst agg      = $items('Aggregate Lines & Totals')[0].json;\nconst ref      = String(agg.ref || '').trim();\nconst chat_id  = String(agg.chat_id || '').trim();\n\n// All rows coming from \"GS: Read Orders (by ref)\"\nconst ordersRows = normalizeRows($input.all());\n\n// Find a row where (OrderNumber == ref OR LastOrderNumber == ref) AND chat_id matches\nconst order = ordersRows.find(r => {\n  const rChat = String(r.chat_id ?? '').trim();\n  const ord   = String(r.OrderNumber ?? '').trim();\n  const last  = String(r.LastOrderNumber ?? '').trim();\n  return rChat === chat_id && (ord === ref || last === ref);\n}) || {};\n\n// Pull values & recompute\nconst deliveryFee = Number(order.DeliveryFee ?? order.deliveryFee ?? 0);\nconst fulfillment = String(order.Fulfillment ?? order.fulfillment ?? '');\nconst orderRowNum = order.row_number ?? null;\n\nreturn [{\n  json: {\n    ...agg,\n    deliveryFee,\n    total: Number(agg.subtotal || 0) + deliveryFee,\n    fulfillment,\n    orderRow_number: orderRowNum\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1600,
        2464
      ],
      "id": "d6cb592b-cde6-4e1e-ac32-cfda173b6f0d",
      "name": "Attach Delivery Fee"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Build Freeze Updates\n * Inputs: cart rows + guard context\n * Output: one item per cart row with Frozen/Payment fields set.\n */\n\nconst items = $input.all();\nconst rows = [];\nfor (const item of items) {\n  const json = item && item.json ? item.json : {};\n  const rowNum = Number(json.row_number);\n  if (Number.isFinite(rowNum) && rowNum > 0) {\n    rows.push({ ...json, row_number: rowNum });\n  }\n}\n\nif (!rows.length) {\n  return [];\n}\n\nconst now = new Date().toISOString();\n\nreturn rows.map(row => ({\n  json: {\n    row_number: row.row_number,\n    Frozen: 'TRUE',\n    CurrentStep: 'paid',\n    PaymentStatus: 'PAID',\n    UpdatedAt: now,\n  },\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2272,
        3488
      ],
      "id": "eca3da1b-81cc-4e82-9eee-1717063b50be",
      "name": "Build Freeze Updates"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.row_number }}",
            "Frozen": "={{ $json.Frozen }}",
            "CurrentStep": "={{ $json.CurrentStep }}",
            "PaymentStatus": "={{ $json.PaymentStatus }}",
            "UpdatedAt": "={{ $json.UpdatedAt }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "Timestamp",
              "displayName": "Timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LineId",
              "displayName": "LineId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "SKU",
              "displayName": "SKU",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Dish",
              "displayName": "Dish",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Price",
              "displayName": "Price",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Quantity",
              "displayName": "Quantity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LineTotal",
              "displayName": "LineTotal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "OrderNumber",
              "displayName": "OrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Frozen",
              "displayName": "Frozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2048,
        3488
      ],
      "id": "4cc312bd-2ce3-4ece-9adf-22c701cfb921",
      "name": "GS: Update Cart Lines",
      "retryOnFail": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "PaymentStatus": "PAID",
            "CurrentStep": "paid",
            "LastOrderNumber": "={{ $json.ref }}",
            "UpdatedAt": "={{ $now }}",
            "CartFrozen": "TRUE"
          },
          "matchingColumns": [
            "chat_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fulfillment",
              "displayName": "Fulfillment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Zone",
              "displayName": "Zone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "DeliveryFee",
              "displayName": "DeliveryFee",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderUID",
              "displayName": "LastOrderUID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "UpdatedAt",
              "displayName": "UpdatedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CartFrozen",
              "displayName": "CartFrozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -1392,
        4160
      ],
      "id": "03b42871-8335-4faf-ae4c-c9e985ca9549",
      "name": "GS: Update UserStates (mark paid)",
      "retryOnFail": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "45aa099a-fff5-42d8-80b7-8d3959ff65d7",
              "leftValue": "={{ Number($json.row_number || 0) > 0 }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1824,
        2512
      ],
      "id": "838b4e01-7480-4105-9cd0-f1744ab4fb77",
      "name": "IF: Has Order row?"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{$json.row_number}}",
            "CurrentStep": "paid",
            "PaymentStatus": "PAID"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "Timestamp",
              "displayName": "Timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LineId",
              "displayName": "LineId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "SKU",
              "displayName": "SKU",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Dish",
              "displayName": "Dish",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Price",
              "displayName": "Price",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Quantity",
              "displayName": "Quantity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LineTotal",
              "displayName": "LineTotal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "OrderNumber",
              "displayName": "OrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Frozen",
              "displayName": "Frozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Deleted",
              "displayName": "Deleted",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "OrderUID",
              "displayName": "OrderUID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -1136,
        3952
      ],
      "id": "1e97ff1d-98a8-4803-8fd5-7b46a1f5f908",
      "name": "GS: Update Orders (mark paid)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Build Kitchen Message \u2014 APPROVE\n// expects from \"Attach Delivery Fee \u2014 APPROVE\":\n//   ref, fulfillment, itemLines[], subtotal, deliveryFee, total\n\nconst KITCHEN_CHAT_ID = -1002927487274;   // <-- replace with YOUR kitchen chat/channel id\n\n// pull + normalize\nconst ref          = String($json.ref || '\u2014');\nconst fulfill      = String($json.fulfillment || 'delivery');\nconst items        = Array.isArray($json.itemLines) ? $json.itemLines : [];\nconst subtotal     = Number($json.subtotal || 0);\nconst deliveryFee  = Number($json.deliveryFee || 0);\nconst total        = Number($json.total || (subtotal + deliveryFee));\n\n// guard: if no kitchen id, bail quietly\nif (!KITCHEN_CHAT_ID) return [];\n\n// money helper (cedi)\nconst money = n => `\u20b5${Number(n || 0).toFixed(2)}`;\n\nconst lineSep = '__________________________________';\nconst bullet  = items.length\n  ? items.map((l, i) => `${i + 1}. ${l}`).join('\\n')    // 1-based numbering\n  : '\u2014';\n\nconst text = [\n  '\u2705 *PAID ORDER*',\n  `Ref: *${ref}*`,\n  `Fulfillment: *${fulfill}*`,\n  '',\n  'Items:',\n  bullet,\n  '',\n  `Subtotal: ${money(subtotal)}`,\n  `Delivery fee: ${money(deliveryFee)}`,\n  lineSep,\n  `TOTAL: *${money(total)}*`,\n  lineSep\n].join('\\n');\n\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id: KITCHEN_CHAT_ID,\n      text,\n      parse_mode: 'Markdown'\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1616,
        3776
      ],
      "id": "1c3ee7c8-e19e-4f48-889f-c780ccb24a77",
      "name": "Build Kitchen Message"
    },
    {
      "parameters": {
        "jsCode": "// Customer Ack (APPROVE path)\n// expects: chat_id, ref, total, fulfillment (from Attach Delivery Fee \u2014 APPROVE)\n\nconst chatId  = String($json.chat_id || '');\nconst ref     = String($json.ref || '\u2014');\nconst fulfill = String($json.fulfillment || 'your order');\nconst total   = Number($json.total || 0);\n\n// (Optional) guard: if chatId is missing, do nothing to avoid HTTP error\nif (!chatId) return [];\n\nconst text = [\n  '\u2705 *Payment received!*',\n  `Ref: *${ref}*`,\n  '',\n  `Total paid: *\u20b5${total.toFixed(2)}*`,\n  '',\n  `Thanks! We\u2019re preparing for ${fulfill}.`, \n  '_Our driver will call you when it\u2019s ready for delivery/pickup._'\n].join('\\n');\n\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id: chatId,\n      text,\n      parse_mode: 'Markdown',\n      reply_markup: {\n        inline_keyboard: [\n                    [{ text: '\ud83c\udf7d\ufe0f Continue shopping', callback_data: 'MENU|REFRESH' }]\n        ]\n      }\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1616,
        3584
      ],
      "id": "f6c24aa7-345a-47ff-8472-a409b4ca5d0a",
      "name": "Build Customer Ack"
    },
    {
      "parameters": {
        "jsCode": "const ADMIN_CHAT_ID = -1002927487274; // <-- your staff chat id\nconst { ref, chat_id, itemLines = [], subtotal = 0, deliveryFee = 0, total = 0, fulfillment = '' } = $json;\n\n// keep callback small: only ref + chat_id\nconst packed = JSON.stringify({ ref, chat_id });\n\nconst txt = [\n  '\ud83e\uddfe *Payment review*',\n  `Ref: *${ref}*`,\n  fulfillment ? `Fulfillment: *${fulfillment}*` : '',\n  '',\n  'Items:',\n  ...itemLines,\n  '',\n  `Subtotal: *\u20b5${(+subtotal).toFixed(2)}*`,\n  deliveryFee > 0 ? `Delivery fee: *\u20b5${(+deliveryFee).toFixed(2)}*` : '',\n  '\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501',\n  `TOTAL: *\u20b5${(+total).toFixed(2)}*`,\n  '\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501',\n].filter(Boolean).join('\\n');\n\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id: ADMIN_CHAT_ID,\n      text: txt,\n      parse_mode: 'Markdown',\n      reply_markup: {\n        inline_keyboard: [[\n          { text: '\u2705 Approve', callback_data: `ADMIN|APPROVE|${packed}` },\n          { text: '\u274c Reject',  callback_data: `ADMIN|REJECT|${packed}` }\n        ]]\n      }\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1376,
        2464
      ],
      "id": "825d4b59-682d-4f0e-bf9f-ed3707ede549",
      "name": "Build Admin Review Message"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.data }}",
                    "rightValue": "ADMIN|APPROVE",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "4d282e37-536b-4c31-8e50-aa5353ca13ef"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "approve"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c2dbb448-ee59-47a7-b1bd-73ec4fe25eb3",
                    "leftValue": "={{ $json.data }}",
                    "rightValue": "ADMIN|REJECT",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reject"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3808,
        3824
      ],
      "id": "780e72f5-d76e-4506-a206-078f1bfcd919",
      "name": "ADMIN?"
    },
    {
      "parameters": {
        "jsCode": "// Input: callback_data like \"ADMIN|APPROVE|{\"ref\":\"SFK-XXXX\",\"chat_id\":\"5441626742\"}\"\nconst evt = $json;\nconst parts = String(evt.data || '').split('|');\nconst action = parts[1]; // APPROVE or REJECT\nlet packed = {};\ntry { packed = JSON.parse(parts[2] || '{}'); } catch (e) { packed = {}; }\n\nconst user_chat_id  = String(packed.chat_id || '');         // the CUSTOMER we\u2019re acting on\nconst admin_chat_id = String(evt.chat_id || '');             // the admin/channel who tapped\nconst ref           = String(packed.ref || '');\n\nreturn [{\n  json: {\n    action,                  // \"APPROVE\" / \"REJECT\"\n    ref,                     // order reference\n    // IMPORTANT: from here on, chat_id = CUSTOMER (for states/orders/messages to user)\n    chat_id: user_chat_id,\n    user_chat_id,\n    admin_chat_id,           // keep for admin ack if you need it\n    cqid: evt.cqid || evt.callback_query_id || null,\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3168,
        3408
      ],
      "id": "f8ad5798-61ed-4cb7-a3e1-ab2e286f85b5",
      "name": "Extract Admin Action"
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    method: 'answerCallbackQuery',\n    payload: { callback_query_id: $json.cqid, text: 'Noted.', show_alert: false }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2944,
        3200
      ],
      "id": "6da06297-9ba3-4410-b0aa-8c75c03620b7",
      "name": "Answer Admin Callback"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "PaymentStatus": "={{ $json.PaymentStatus || 'REJECTED' }}",
            "CurrentStep": "={{ $json.CurrentStep || 'rejected' }}",
            "CartFrozen": "={{ $json.CartFrozen || 'TRUE' }}",
            "LastOrderNumber": "={{ $json.LastOrderNumber || $items('Extract Admin Action(Reject)')[0].json.ref }}",
            "UpdatedAt": "={{ $json.UpdatedAt || $now }}"
          },
          "matchingColumns": [
            "chat_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fulfillment",
              "displayName": "Fulfillment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Zone",
              "displayName": "Zone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "DeliveryFee",
              "displayName": "DeliveryFee",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "LastOrderUID",
              "displayName": "LastOrderUID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "UpdatedAt",
              "displayName": "UpdatedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CartFrozen",
              "displayName": "CartFrozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2272,
        4112
      ],
      "id": "b500b590-a58f-4e78-b436-bf0f0be54401",
      "name": "GS: Update UserStates (reject)",
      "retryOnFail": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const ex = $items('Extract Admin Action(Reject)')[0]?.json || {};\nconst chat_id = String($json.chat_id || ex.chat_id || '');\nif (!chat_id) return [];\n\nconst ref     = String($json.OrderNumber || $json.ref || ex.ref || '\u2014');\nconst fulfill = String($json.Fulfillment || $json.fulfillment || 'your order');\nconst reason  = String(ex.reject_reason || $json.reject_reason || '').trim();\n\nconst text = [\n  '\u274c *Order not accepted*',\n  `Ref: *${ref}*`,\n  '',\n  `We\u2019re unable to proceed with ${fulfill} at this time.`,\n  reason ? `Reason: _${reason}_` : '',\n  '',\n  'You can try again or contact us below:'\n].filter(Boolean).join('\\n');\n\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id, text, parse_mode: 'Markdown',\n      reply_markup: { inline_keyboard: [\n        [{ text: '\ud83e\uddfe View menu',  callback_data: 'MENU|OPEN' }],\n        [{ text: '\ud83d\udd01 Start over', callback_data: 'RESET|START' }],\n        [{ text: '\u260e\ufe0f Contact support', callback_data: 'HELP|AGENT' }]\n      ] }\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2496,
        4560
      ],
      "id": "d3332148-25ae-4836-866d-102f047a910b",
      "name": "Notify Customer (rejected)"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Guard: stop duplicate \"Approve\" runs.\n * Blocks when the last processed order matches this ref\n * and is already paid, rejected, or frozen.\n */\n\nfunction safeItems(nodeName) {\n  try {\n    return ($items(nodeName) || []).map(i => (i && typeof i.json === 'object') ? i.json : {});\n  } catch (e) {\n    return [];\n  }\n}\n\nconst ctxRaw = safeItems('Extract Admin Action')[0] || {}; // always pull from the approve context\nconst asString = (value) => (value == null ? '' : String(value));\nconst chatId = asString(ctxRaw.chat_id || ctxRaw.user_chat_id || $json.chat_id).trim();\nconst ref = asString(ctxRaw.ref || $json.ref).trim();\n\nconst stateRows = $input.all().map(item => (item && typeof item.json === 'object') ? item.json : {});\nconst state = stateRows.find(r => asString(r.chat_id || r.ChatID).trim() === chatId) || {};\n\nconst status = asString(state.PaymentStatus || state.paymentstatus).trim().toUpperCase();\nconst paid = status === 'PAID';\nconst rejected = status === 'REJECTED';\nconst frozen = asString(state.CartFrozen || state.cartfrozen).trim().toUpperCase() === 'TRUE';\nconst lastRef = asString(state.LastOrderNumber || state.lastordernumber).trim();\n\nconst isSameOrder = Boolean(lastRef && ref && lastRef === ref);\n\nif (!chatId || !ref) {\n  return [{ json: { ...ctxRaw, ...$json, chat_id: chatId, ref } }];\n}\n\nif (isSameOrder && (paid || rejected || frozen)) {\n  return [];\n}\n\nreturn [{ json: { ...ctxRaw, ...state, chat_id: chatId, ref } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2496,
        3408
      ],
      "id": "30d0f434-0cb9-4407-b3d4-cfe8cc9fcec4",
      "name": "Guard: Already Paid?"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2720,
        3488
      ],
      "id": "6694ca43-21ab-4268-a91b-0b55ccd06d0b",
      "name": "GS: Read UserStates (by chat_id)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "OrderNumber",
              "lookupValue": "={{ ($json.ref || '').trim() }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2944,
        3792
      ],
      "id": "d3be037a-c381-40bd-96cd-19d3165a94d8",
      "name": "GS: Read Cart (by ref) \u2014 APPROVE",
      "retryOnFail": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "chat_id",
              "lookupValue": "={{$json.chat_id}}"
            },
            {
              "lookupColumn": "OrderNumber",
              "lookupValue": "={{$json.ref}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2944,
        2592
      ],
      "id": "11db58b7-3968-40a4-9b0e-bccec242c866",
      "name": "GS: Read Cart (by ref) \u2014 REVIEW",
      "retryOnFail": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/{{ $json.method }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1152,
        2464
      ],
      "id": "0d403c9e-5f37-44ae-a4ec-7af979b24f25",
      "name": "HTTP Send \u2192 Admin Review"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/{{ $json.method }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2720,
        2784
      ],
      "id": "79eff4d0-f026-4ce4-aa13-d193e040d0e6",
      "name": "HTTP Send \u2192 Customer Processing"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/{{ $json.method }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1392,
        3584
      ],
      "id": "7611a75b-00f0-44a2-8e63-e98bafaa54a6",
      "name": "HTTP Send \u2192 Customer Paid"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/{{ $json.method }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1392,
        3776
      ],
      "id": "8a0ff736-af3c-4087-95de-0de97149e15e",
      "name": "HTTP Send \u2192 Kitchen Paid"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/{{ $json.method }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2720,
        3200
      ],
      "id": "fc73a955-d3ad-4008-9214-5801c3863402",
      "name": "HTTP: Telegram Send"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/{{ $json.method }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1376,
        2688
      ],
      "id": "632521c2-4129-497f-8f1b-1fb17c86e41d",
      "name": "HTTP Send \u2192 CUSTOMER Ref Not Found"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Drop items whose chat_id looks like a channel/supergroup (-100\u2026)\n * or any non-positive id. Only allow real user ids.\n */\nconst id = String($json.chat_id || '');\nconst isChannelLike = id.startsWith('-100');\nconst isNonPositive  = /^-?\\d+$/.test(id) && Number(id) <= 0;\n\nif (isChannelLike || isNonPositive) {\n  // don't write state for channels/groups\n  return [];\n}\n\n// pass through\nreturn [{ json: $json }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2944,
        3488
      ],
      "id": "dfa561ab-1ef4-430a-963a-71f19ef1c40d",
      "name": "Guard: Skip Channel IDs"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Drop items whose chat_id looks like a channel/supergroup (-100\u2026)\n * or any non-positive id. Only allow real user ids.\n */\nconst id = String($json.chat_id || '');\nconst isChannelLike = id.startsWith('-100');\nconst isNonPositive  = /^-?\\d+$/.test(id) && Number(id) <= 0;\n\nif (isChannelLike || isNonPositive) {\n  // don't write state for channels/groups\n  return [];\n}\n\n// pass through\nreturn [{ json: $json }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1616,
        4160
      ],
      "id": "01f7b36a-7750-4413-828f-98f31f0e5973",
      "name": "Guard: Skip Channel IDs1"
    },
    {
      "parameters": {
        "jsCode": "const id = String($json.chat_id || '');\nif (id.startsWith('-100') || (!/^\\d+$/.test(id)) || Number(id) <= 0) return [];\nreturn [{ json: $json }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2720,
        4112
      ],
      "id": "ee7b43be-9cc2-422b-8f3b-f177756a90bf",
      "name": "Guard: Skip Channel IDs2"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Drop items whose chat_id looks like a channel/supergroup (-100\u2026)\n * or any non-positive id. Only allow real user ids.\n */\nconst id = String($json.chat_id || '');\nconst isChannelLike = id.startsWith('-100');\nconst isNonPositive  = /^-?\\d+$/.test(id) && Number(id) <= 0;\n\nif (isChannelLike || isNonPositive) {\n  // don't write state for channels/groups\n  return [];\n}\n\n// pass through\nreturn [{ json: $json }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2896,
        1264
      ],
      "id": "788c76c5-7a38-4d1f-8d16-3631477489d4",
      "name": "Guard: Skip Channel IDs3"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Drop items whose chat_id looks like a channel/supergroup (-100\u2026)\n * or any non-positive id. Only allow real user ids.\n */\nconst id = String($json.chat_id || '');\nconst isChannelLike = id.startsWith('-100');\nconst isNonPositive  = /^-?\\d+$/.test(id) && Number(id) <= 0;\n\nif (isChannelLike || isNonPositive) {\n  // don't write state for channels/groups\n  return [];\n}\n\n// pass through\nreturn [{ json: $json }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3568,
        1264
      ],
      "id": "4e22773c-10f7-4ab6-951b-bf8b7ca37faa",
      "name": "Guard: Skip Channel IDs4"
    },
    {
      "parameters": {
        "jsCode": "// APPROVE aggregator \u2013 no cross-branch references\nconst ctx = ($items('Extract Admin Action')[0]?.json) || {};\nconst chat_id = String(ctx.chat_id || '');\nconst ref     = String(ctx.ref || '');\n\n// cart rows arrive as $input items\nconst lines = $input.all().map(i => i.json);\n\n// subtotal from LineTotal (fallback to Price*Quantity)\nlet subtotal = 0;\nconst money = n => `\u00a2${Number(n || 0).toFixed(2)}`;\n\nfor (const l of lines) {\n  const lt = Number(l.LineTotal || 0);\n  const p  = Number(l.Price || 0);\n  const q  = Number(l.Quantity || 0);\n  subtotal += lt > 0 ? lt : (p * q);\n}\n\nconst itemLines = lines.map(l => {\n  const qty = Number(l.Quantity || 0);\n  const line = Number(l.LineTotal || (Number(l.Price||0) * qty));\n  return `\u2022 ${l.Dish} x${qty} \u2014 ${money(line)}`;\n});\n\nreturn [{\n  json: {\n    chat_id, ref, lines, subtotal, itemLines\n    // deliveryFee & total added next node\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2720,
        3872
      ],
      "id": "48229d87-f9b6-4b15-8983-b079abed44ce",
      "name": "Aggregate Lines & Totals \u2014 APPROVE"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2496,
        3792
      ],
      "id": "50893f4f-9678-445e-a18c-023e9bb55dbd",
      "name": "GS: Read Orders (by ref)-Approve",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Attach Delivery Fee \u2014 APPROVE (after Merge)\nconst chat_id     = String($json.chat_id || '');\nconst ref         = String($json.ref || '\u2014');\n\nconst subtotal    = Number($json.subtotal || 0);\nconst itemLines   = Array.isArray($json.itemLines) ? $json.itemLines : [];\nconst lines       = Array.isArray($json.lines) ? $json.lines : [];\n\nconst row_number  = Number($json.row_number);                           // <\u2014 pass this through\nconst fulfillment = String($json.Fulfillment || $json.fulfillment || '');\nconst deliveryFee = Number(($json.DeliveryFee ?? $json.deliveryFee) || 0);\nconst total       = subtotal + deliveryFee;\n\n// guard: no row_number, don\u2019t proceed (prevents null errors downstream)\nif (!Number.isFinite(row_number) || row_number <= 0) return [];\n\nreturn [{\n  json: { chat_id, ref, row_number, fulfillment, lines, itemLines, subtotal, deliveryFee, total }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2048,
        3872
      ],
      "id": "ae1f28b7-b80f-4abc-bc57-111d2e3054b7",
      "name": "Attach Delivery Fee \u2014 APPROVE"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -2272,
        3872
      ],
      "id": "bff8c3db-582f-47c2-b329-99fda2a2209d",
      "name": "Merge (agg + order)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/{{ $json.method }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2272,
        4544
      ],
      "id": "505d2556-fdb0-427d-80ef-5594754db6b3",
      "name": "HTTP Send \u2192 Customer Reject"
    },
    {
      "parameters": {
        "jsCode": "// Build Reject Updates (cart lines) with admin notification\nconst all = $input.all();\nconst rows = [];\nfor (const item of all) {\n  const json = item && item.json ? item.json : {};\n  const rowNum = Number(json.row_number);\n  if (Number.isFinite(rowNum) && rowNum > 0) {\n    rows.push({ ...json, row_number: rowNum });\n  }\n}\n\nconst ctxItems = $items('Extract Admin Action(Reject)') || [];\nconst ctx = ctxItems.length ? (ctxItems[0].json || {}) : {};\nconst adminChatId = String(ctx.admin_chat_id || '').trim();\nconst ref = String(ctx.ref || '').trim();\n\nconst updates = [];\nconst now = new Date().toISOString();\nfor (const row of rows) {\n  const status = String(row.PaymentStatus || '').toUpperCase();\n  if (status === 'PAID') {\n    continue;\n  }\n  updates.push({\n    json: {\n      row_number: row.row_number,\n      Frozen: 'TRUE',\n      CurrentStep: 'rejected',\n      PaymentStatus: 'REJECTED',\n      UpdatedAt: now,\n    }\n  });\n}\n\nconst outputs = [updates, []];\n\nif (adminChatId && (rows.length === 0 || updates.length === 0)) {\n  const reason = rows.length === 0\n    ? 'No cart lines found for this reference.'\n    : 'All lines are already handled (paid or rejected).';\n  const text = [\n    '\u26a0\ufe0f *Nothing to update*',\n    ref ? `Ref: *${ref}*` : '',\n    '',\n    reason,\n    'If this order was already processed, you can ignore this button.',\n  ].filter(Boolean).join('\\n');\n\n  outputs[1].push({\n    json: {\n      method: 'sendMessage',\n      payload: {\n        chat_id: adminChatId,\n        text,\n        parse_mode: 'Markdown',\n      },\n    },\n  });\n}\n\nreturn outputs;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2960,
        4656
      ],
      "id": "b362b09f-5030-46fd-952b-7d7eeaaa02cf",
      "name": "Build Reject Updates (cart lines)"
    },
    {
      "parameters": {
        "jsCode": "// Build UserState Reject Update (robust)\nconst refFromExtract = $items('Extract Admin Action(Reject)')[0]?.json?.ref || '';\nreturn [{\n  json: {\n    chat_id: $json.chat_id,\n    CurrentStep: 'rejected',\n    PaymentStatus: 'REJECTED',\n    LastOrderNumber: refFromExtract,\n    CartFrozen: 'TRUE',\n    UpdatedAt: new Date().toISOString(),\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2496,
        4112
      ],
      "id": "ec64840a-1615-42a5-8d0d-9b06f0043989",
      "name": "Build UserState Reject Update"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "OrderNumber",
              "lookupValue": "={{$items('Extract Admin Action(Reject)')[0].json.ref.trim()}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -3168,
        4656
      ],
      "id": "969ab2d7-d502-485f-b0c5-69500ffd274c",
      "name": "GS: Read Cart (by ref) \u2014 REJECT",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2944,
        4112
      ],
      "id": "963021c3-04e7-43c1-b1a2-41e662c4948b",
      "name": "GS: Read UserStates (by chat_id)2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1157785025,
          "mode": "list",
          "cachedResultName": "Cart",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1157785025"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.row_number }}",
            "Frozen": "={{ $json.Frozen }}",
            "CurrentStep": "={{ $json.CurrentStep }}",
            "PaymentStatus": "={{ $json.PaymentStatus }}",
            "UpdatedAt": "={{ $json.UpdatedAt }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "Timestamp",
              "displayName": "Timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LineId",
              "displayName": "LineId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "SKU",
              "displayName": "SKU",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Dish",
              "displayName": "Dish",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Price",
              "displayName": "Price",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Quantity",
              "displayName": "Quantity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LineTotal",
              "displayName": "LineTotal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "OrderNumber",
              "displayName": "OrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Frozen",
              "displayName": "Frozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -2016,
        4784
      ],
      "id": "9b5a1a6a-47eb-4f11-8b0d-9ed5059ca256",
      "name": "GS: Update Cart Lines1",
      "retryOnFail": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract Admin Action (REJECT-only)\nconst raw = String($json.data || $json.callback_data || '').trim();\nconst parts = raw.split('|');            // ADMIN|REJECT|{...}\nconst action = (parts[1] || '').toUpperCase();\nif (action !== 'REJECT') return [];      // <\u2014 ignore non-reject taps\n\nlet packed = {};\ntry { packed = JSON.parse(parts[2] || '{}'); } catch {}\n\nconst user_chat_id  = String(packed.chat_id || '');\nconst admin_chat_id = String($json.chat_id || $json.message?.chat?.id || '');\nconst message_id    = String($json.message_id || $json.message?.message_id || '');\nconst cqid          = $json.cqid || $json.callback_query_id || $json.callback_query?.id || null;\n\nreturn [{\n  json: {\n    action,\n    ref: String(packed.ref || packed.OrderNumber || ''),\n    chat_id: user_chat_id,          // <- customer\n    user_chat_id,\n    admin_chat_id,\n    message_id,\n    cqid,\n    reject_reason: packed.reason || '' // if you include a reason in the payload\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3168,
        4304
      ],
      "id": "b9327790-142f-4cee-b01b-eeab59ff497a",
      "name": "Extract Admin Action(Reject)"
    },
    {
      "parameters": {
        "resource": "callback",
        "queryId": "={{$json.cqid || $json.callback_query_id || $json.callback_query?.id}}\n",
        "additionalFields": {
          "text": "=Rejected: {{$items('Extract Admin Action(Reject)')[0].json.ref}}"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2720,
        4304
      ],
      "id": "239862e8-29ca-43c8-9cba-04ad6f53cc1a",
      "name": "Answer Admin Callback (spinner off)",
      "webhookId": "3e6fe68a-3dc9-4770-9009-c86fb22472d5",
      "credentials": {
        "telegramApi": {
          "id": "GWiNIWfCwEPeHIOg",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Guard: Already Reviewed?\n// Read UserStates (by chat_id) or Cart (by ref) before this guard\nconst status = ($json.PaymentStatus || '').toUpperCase(); // from state or a prior read\nif (status === 'PAID' || status === 'REJECTED') return []; // drop duplicate taps\nreturn [{ json: $json }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2944,
        4304
      ],
      "id": "1e1c26d9-210f-4223-92bb-6d2a70dcb4a3",
      "name": "Guard: Already Reviewed?"
    },
    {
      "parameters": {
        "jsCode": "// Reply: Contact Support\nconst chat_id = $json.chat_id;\n\nconst text = [\n  '\u260e\ufe0f *Contact support*',\n  'Our driver or team will call you when your order is ready.',\n  '',\n  'If it\u2019s urgent, call: *0243 957 386*',\n  'Or reply here and we\u2019ll assist shortly.'\n].join('\\n');\n\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id,\n      text,\n      parse_mode: 'Markdown'\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        4960
      ],
      "id": "cfe89465-102e-41dd-bb7d-b71a7fa54eac",
      "name": "Reply: Contact Support"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/{{$json.method || 'sendMessage'}}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.payload) }}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -64,
        4960
      ],
      "id": "27bcd407-ea45-4228-a2a8-78794f3c9a49",
      "name": "HTTP: Send (customer)"
    },
    {
      "parameters": {
        "jsCode": "// Set Pickup Context\n// Input: must contain chat_id (from Parse Callback -> Action Router -> this node)\n// Output: one item with fields to write into UserStates\nconst chat_id = String($json.chat_id || '');\nif (!chat_id) return []; // safety\n\nreturn [{\n  json: {\n    chat_id,\n    Fulfillment: 'pickup',\n    CurrentStep: 'await_phone',\n    // clear delivery-only fields\n    Address: '',\n    Zone: '',\n    DeliveryFee: '',\n    PaymentStatus: '',   // don't force to PAID/REJECTED here\n    CartFrozen: 'FALSE',\n    UpdatedAt: $now\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        256,
        4704
      ],
      "id": "24fd3176-eb26-4b28-ae4f-cd565ee8df64",
      "name": "Set Pickup Context"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{$json.chat_id}}",
            "Fulfillment": "={{ $json.Fulfillment ?? 'pickup' }}",
            "CurrentStep": "={{$json.CurrentStep}}",
            "Address": "={{ $json.Address ?? '' }}",
            "Zone": "={{ $json.Zone ?? '' }}",
            "DeliveryFee": "={{ $json.DeliveryFee ?? '' }}",
            "PaymentStatus": "={{ $json.PaymentStatus ?? '' }}",
            "CartFrozen": "={{ $json.CartFrozen ?? 'FALSE' }}",
            "UpdatedAt": "={{$now}}"
          },
          "matchingColumns": [
            "chat_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fulfillment",
              "displayName": "Fulfillment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Zone",
              "displayName": "Zone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "DeliveryFee",
              "displayName": "DeliveryFee",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderUID",
              "displayName": "LastOrderUID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "UpdatedAt",
              "displayName": "UpdatedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CartFrozen",
              "displayName": "CartFrozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        736,
        4592
      ],
      "id": "f4aca482-572e-4891-944e-ea515d548c5f",
      "name": "GS: Update UserStates (pickup)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/{{$json.method || 'sendMessage'}}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.payload) }}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        912,
        4800
      ],
      "id": "6b356feb-6633-4eab-ad35-022e19cf0ad2",
      "name": "HTTP: Send (customer Pickup)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "44302742-74f7-4a7b-b04a-d9a9069518b6",
              "leftValue": "={{$json.Fulfillment}}",
              "rightValue": "delivery",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        544,
        304
      ],
      "id": "c6d438d4-9666-41e7-a1b9-f4e808506535",
      "name": "IF: Fulfillment is delivery?"
    },
    {
      "parameters": {
        "jsCode": "// Reply: Pickup \u2192 Ask Phone\nconst chat_id = $json.chat_id;\n\nconst text = [\n  '\ud83c\udfea *Pickup selected.*',\n  'Please reply with your *phone number* (e.g., `0241234567` or `+233241234567`).'\n].join('\\n');\n\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id,\n      text,\n      parse_mode: 'Markdown',\n      reply_markup: {\n        inline_keyboard: [\n          [{ text: 'Change to Delivery', callback_data: 'FULFILL|DELIVERY' }]\n        ]\n      }\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        688,
        4800
      ],
      "id": "c57a3ba4-35e2-4661-9e48-eda5410c4b16",
      "name": "Reply: Pickup \u2192 Ask Phone"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot8293686289:AAEhX_BZ-5FZBbeH3yI6PDMPVu-Ao_4CXDM/{{$json.method || 'sendMessage'}}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.payload) }}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2496,
        720
      ],
      "id": "1aeedee7-06a5-4b2f-869c-7049e1ece881",
      "name": "HTTP Request (sendMessage)"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1824,
        592
      ],
      "id": "5d8bb942-3426-48c0-b40c-ea0dccc88b4a",
      "name": "GS: Read State (summary)",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * Attach State \u2192 Lines (checkout) \u2014 robust chat_id + frozen filter\n * Joins the single UserStates row onto each cart line so the summary can\n * see Fulfillment / Address / DeliveryFee / Phone.\n *\n * Inputs (by name \u2013 but we also fall back to $input when run alone):\n *   - GS: Read Cart (checkout)   \u2192 cart lines\n *   - GS: Read State (summary)   \u2192 all UserStates rows\n */\n\nfunction fromNode(name) {\n  try { return $items(name).map(i => i.json); }\n  catch (_) { return []; }\n}\n\n// 1) Collect inputs\nlet cartAll   = fromNode('GS: Read Cart (checkout)');\nlet statesAll = fromNode('GS: Read State (summary)');\n\n// Fallback when executing this node alone\nif (cartAll.length === 0 || statesAll.length === 0) {\n  const ins = $input.all().map(i => i.json);\n  if (cartAll.length === 0) {\n    cartAll = ins.filter(r => r && (r.SKU || r.sku || r.Dish));\n  }\n  if (statesAll.length === 0) {\n    statesAll = ins.filter(r =>\n      r && (\n        r.chat_id !== undefined || r.ChatID !== undefined ||\n        r.Fulfillment !== undefined || r.CurrentStep !== undefined ||\n        r.Address !== undefined || r.Zone !== undefined ||\n        r.DeliveryFee !== undefined || r.Phone !== undefined\n      )\n    );\n  }\n}\n\n// 2) Drop frozen lines first\nconst isFrozen = v => {\n  const t = String(v ?? '').trim().toLowerCase();\n  return t === 'true' || t === '1' || t === 'yes';\n};\nconst cart = cartAll.filter(r => !isFrozen(r.Frozen));\n\n// 3) Resolve chat_id AFTER filtering (and with fallbacks)\nconst chatIdCandidates = [\n  ...cart.map(r => r?.chat_id ?? r?.ChatID),\n  ...statesAll.map(s => s?.chat_id ?? s?.ChatID),\n  $json._chat_id, $json.chat_id\n].map(v => (v == null ? '' : String(v))).filter(v => v && v !== 'empty');\n\nconst chatId = chatIdCandidates[0] || '';\n\n// 4) Pick this user's state row (or default)\nconst state = statesAll.find(s => String(s?.chat_id ?? s?.ChatID) === chatId) || {};\nconst s = {\n  chat_id: chatId,\n  Fulfillment: String(state.Fulfillment || '').toLowerCase(),\n  Address: state.Address || '',\n  Zone: state.Zone || '',\n  DeliveryFee: Number(state.DeliveryFee || 0) || 0,\n  Phone: state.Phone || ''\n};\n\n// 5) Emit one item per active cart line with state attached\nconst out = cart.map(r => ({ json: { ...r, ...s } }));\nreturn out.length ? out : [];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2064,
        720
      ],
      "id": "05c3e9ab-e002-4f9e-8185-45c9204829dc",
      "name": "Attach State \u2192 Lines (checkout)"
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I",
          "mode": "list",
          "cachedResultName": "SefakeBot",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1083285361,
          "mode": "list",
          "cachedResultName": "UserStates",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1XTREud-U1BRWVTCubTl4yvHtiTYEZ_toAIR_Bd-zE8I/edit#gid=1083285361"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Fulfillment": "={{$json.Fulfillment}}",
            "chat_id": "={{$json.chat_id}}",
            "CurrentStep": "={{$json.CurrentStep}}",
            "Address": "={{ $json.Address ?? '' }}",
            "Zone": "={{ $json.Zone ?? '' }}",
            "DeliveryFee": "={{ $json.DeliveryFee ?? '' }}",
            "UpdatedAt": "={{$now}}",
            "CartFrozen": "={{ $json.CartFrozen ?? 'FALSE' }}",
            "PaymentStatus": "={{ $json.PaymentStatus ?? '' }}"
          },
          "matchingColumns": [
            "chat_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "CurrentStep",
              "displayName": "CurrentStep",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Fulfillment",
              "displayName": "Fulfillment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Phone",
              "displayName": "Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Address",
              "displayName": "Address",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Zone",
              "displayName": "Zone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "DeliveryFee",
              "displayName": "DeliveryFee",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderNumber",
              "displayName": "LastOrderNumber",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "LastOrderUID",
              "displayName": "LastOrderUID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "UpdatedAt",
              "displayName": "UpdatedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "CartFrozen",
              "displayName": "CartFrozen",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "PaymentStatus",
              "displayName": "PaymentStatus",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        512,
        4592
      ],
      "id": "a5a28672-3162-4429-b1c8-7e808f9e803c",
      "name": "Append or update row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "qyz1Kgw8ebM5gqPx",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "45214722-c7c0-43a3-8eaa-7acdf8dff641",
              "leftValue": "={{ Array.isArray($json.lines) && $json.lines.length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2272,
        2592
      ],
      "id": "539d2aea-3dcc-425f-8949-a8978f482cd5",
      "name": "If: any lines?"
    },
    {
      "parameters": {
        "jsCode": "const price = Number($json.Price || 0);\nconst current = Number($json.Quantity || 0);\nconst qty = current + 1;\n\nreturn [{\n  json: {\n    ...$json,\n    Quantity: qty,\n    LineTotal: qty * price\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1056,
        1440
      ],
      "id": "e18127af-259a-4a52-9362-69fa3e4c7557",
      "name": "Bump Qty"
    },
    {
      "parameters": {
        "jsCode": "const frozen = String($json.Frozen ?? '').toLowerCase() === 'true';\nconst paid   = String($json.PaymentStatus ?? '').toUpperCase() === 'PAID';\nconst hasOrderNo = String($json.OrderNumber ?? '').trim() !== '';\n\n/**\n * Drop the item if it's a paid/frozen line or already has an order number.\n * Returning [] in n8n means \u201cdon\u2019t pass this item forward\u201d.\n */\nif (frozen || paid || hasOrderNo) {\n  return [];\n}\nreturn [$json];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        160,
        1760
      ],
      "id": "6a2a467e-bc0e-40ce-8ad6-6a3538356bec",
      "name": "guard IF \u2013 invalid syntax"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ba06264c-97cd-4f9f-b9f7-2f05d04b6a95",
              "leftValue": "={{$json.CurrentStep}}",
              "rightValue": "await_addr",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -496,
        608
      ],
      "id": "fbd5a78e-4ed7-4ab9-85c7-3ff46f27ee1b",
      "name": "IF: Awaiting ADDRESS",
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "28b78a75-a587-4c8a-ad9c-de5933815c88",
              "leftValue": "={{$json.CurrentStep}}",
              "rightValue": "await_phone",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -720,
        592
      ],
      "id": "21c11350-d283-4ce6-a491-7d1019d6acce",
      "name": "IF: Awaiting PHONE"
    },
    {
      "parameters": {
        "jsCode": "// Cart lines from the combine gate\nconst cartItems = $input.all();\n\n// Meta from Ensure Order Number (now guaranteed executed)\nlet meta = {};\ntry { meta = ($items('Ensure Order Number')[0]?.json) || {}; }\ncatch { meta = ($node['Ensure Order Number']?.json) || {}; }\n\nconst out = cartItems.map(i => {\n  const j = { ...i.json };\n  if (meta.OrderNumber) j.OrderNumber = meta.OrderNumber;\n  if (meta.OrderUID)    j.OrderUID    = meta.OrderUID;\n  if (meta.Zone !== undefined)        j.Zone        = meta.Zone;\n  if (meta.DeliveryFee !== undefined) j.DeliveryFee = Number(meta.DeliveryFee);\n  return { json: j };\n});\n\nreturn out; // array\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        4048
      ],
      "id": "142e374b-7654-44c2-a7c3-7a99cd5eb0ec",
      "name": "Join: Cart + OrderNo1"
    },
    {
      "parameters": {
        "jsCode": "// Fan-out each order line that is not already PAID.\n// Input: one aggregated item with { lines: [...] }.\nconst all = $input.all();\nif (!all.length) return [];\n\nconst agg = (all[0].json || {});\nconst lines = Array.isArray(agg.lines) ? agg.lines : [];\n\n// Idempotency: skip rows already marked PAID\nconst toUpdate = lines.filter(l =>\n  String(l.PaymentStatus || '').toUpperCase() !== 'PAID'\n);\n\n// Emit one minimal item per line for the Sheets update\nreturn toUpdate.map(l => ({\n  json: {\n    row_number: Number(l.row_number),\n    CurrentStep: 'paid',\n    PaymentStatus: 'PAID',\n  },\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1616,
        3936
      ],
      "id": "7d8b62ce-2ce9-4118-b1a8-31daf6b453f9",
      "name": "Prepare Line Updates (approve)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "562fcb62-1bcf-4c85-9e10-caf502ece7c2",
              "leftValue": "={{ $items(\"Build Reject Updates (cart lines)\").length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2784,
        4576
      ],
      "id": "2c5062db-f1d6-4f61-a109-0934b588afbc",
      "name": "IF: Has Rejectable Lines?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "63d56fc1-f481-4999-b89f-af1ef4207e6e",
              "leftValue": "={{\n  ($json.is_callback !== true) &&\n  /^\\/?(start|menu|hi|hello)$/i.test(($json.text || '').trim())\n    ? true\n    : false\n}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2784,
        1776
      ],
      "id": "fa3f611b-2ac0-442d-a72f-c03c1c42a48a",
      "name": "IF: Is Greeting?"
    },
    {
      "parameters": {
        "jsCode": "const brand = $env.BRAND_NAME || 'Sefake Kitchen';\nconst momo  = $env.MOMO_NUMBER || '';\n\nconst lines = [\n  `\ud83d\udc4b Welcome to *${brand}*!`,\n  `Order delicious meals via Telegram.`,\n  ``,\n  `\u2022 Tap *Menu* to start an order`,\n  `\u2022 Already have a cart? Tap *Checkout*`,\n  ...(momo ? [`\u2022 MoMo: ${momo}`] : []),\n];\n\nconst text = lines.join('\\n');\nconst out = [];\n\nfor (const it of $input.all()) {\n  const j = it.json || {};\n  const chat_id = j.chat_id;\n\n  const reply_markup = {\n    inline_keyboard: [\n      [{ text: '\ud83d\udcd6 Menu',     callback_data: 'MENU|OPEN' }],\n      [{ text: '\ud83e\uddfe Checkout', callback_data: 'CART|CHECKOUT' }]\n    ]\n  };\n\n  out.push({\n    json: {\n      method: 'sendMessage',\n      payload: {\n        chat_id,\n        text,\n        parse_mode: 'Markdown',\n        disable_web_page_preview: true,\n        reply_markup\n      }\n    }\n  });\n}\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2272,
        1712
      ],
      "id": "5bb389c3-3072-4624-b631-d3d17f00f415",
      "name": "Build Greeting"
    },
    {
      "parameters": {
        "jsCode": "// ====== Config via env (safe defaults) ======\nconst OPEN_HHMM  = $env.OPEN_HHMM   || '09:00';                 // 24h\nconst CLOSE_HHMM = $env.CLOSE_HHMM  || '21:00';\nconst OPEN_DAYS  = ($env.OPEN_DAYS  || 'Mon,Tue,Wed,Thu,Fri,Sat')\n  .split(',')\n  .map(s => s.trim().toLowerCase());                            // ['mon', ...]\nconst TZ         = $env.TIMEZONE    || 'Africa/Accra';\nconst HOLIDAYS   = ($env.HOLIDAYS   || '')                      // '2025-12-25,2025-12-26'\n  .split(',')\n  .map(s => s.trim())\n  .filter(Boolean);\n\n// ====== Helpers ======\nfunction inWindow(now, open, close) {\n  // open/close format 'HH:MM'\n  const [oh, om] = open.split(':').map(Number);\n  const [ch, cm] = close.split(':').map(Number);\n  const start = new Date(now); start.setHours(oh, om, 0, 0);\n  const end   = new Date(now); end.setHours(ch, cm, 0, 0);\n\n  // overnight window (e.g., 18:00\u201302:00):\n  if (end <= start) return (now >= start) || (now <= end);\n  return (now >= start) && (now <= end);\n}\n\nconst ev = $input.first()?.json ?? {};\n// current time in business TZ\nconst now = new Date(new Date().toLocaleString('en-US', { timeZone: TZ }));\nconst dayKey = now.toLocaleDateString('en-US', { weekday: 'short' }).slice(0,3).toLowerCase(); // 'mon'\nconst isHoliday  = HOLIDAYS.includes(now.toISOString().slice(0,10));\nconst isOpenDay  = OPEN_DAYS.includes(dayKey);\nconst withinTime = inWindow(now, OPEN_HHMM, CLOSE_HHMM);\n\nconst is_open = isOpenDay && withinTime && !isHoliday;\n\n// Return an item (array-of-items with a json object)\nreturn [{\n  json: {\n    ...ev,                 // keep incoming chat_id, etc.\n    is_open,\n    tz: TZ,\n    now_iso: now.toISOString(),\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3312,
        2048
      ],
      "id": "6ccf6f08-0e61-4484-b786-ed502a25189d",
      "name": "Guard: Kitchen Open?"
    },
    {
      "parameters": {
        "jsCode": "// Closed message (shows hours + days)\nconst brand = $env.BRAND_NAME || 'Sefake Kitchen';\nconst OPEN  = $env.OPEN_HHMM  || '09:00';\nconst CLOSE = $env.CLOSE_HHMM || '20:00';\nconst DAYS  = ($env.OPEN_DAYS || 'Mon,Tue,Wed,Thu,Fri,Sat').split(',').map(s => s.trim()).join(', ');\n\n// Message body\nconst lines = [\n  `\u23f3 *${brand}* is currently *closed*.`,\n  `\ud83d\udd52 *Hours:* ${OPEN}\u2013${CLOSE}`,\n  `\ud83d\udcc5 *Days:* ${DAYS}`,\n  '',\n  `You can still browse the menu. If you\u2019ve already paid, tap *I have paid* in your earlier message.`,\n];\n\nconst text = lines.join('\\n');\n\n// Buttons: safe actions while closed\nconst reply_markup = {\n  inline_keyboard: [\n    [{ text: '\ud83d\udcd6 View menu',     callback_data: 'MENU|OPEN' }],\n    [{ text: '\ud83e\uddfe Go to checkout', callback_data: 'CART|CHECKOUT' }],\n  ]\n};\n\n// Emit Telegram payload expected by your HTTP node\nreturn [{\n  json: {\n    method: 'sendMessage',\n    payload: {\n      chat_id: $json.chat_id,\n      text,\n      parse_mode: 'Markdown',\n      reply_markup,\n    }\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2736,
        2128
      ],
      "id": "87c6d188-b583-4f80-aead-0f051c633d45",
      "name": "Build Closed Message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{$env.TG_BOT_TOKEN}}/{{ $json.method || 'sendMessage' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.payload}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1856,
        1664
      ],
      "id": "1a280af9-2999-40df-ae2c-3e8bcbde74ff",
      "name": "HTTP Send \u2192 Customer (sendMessage)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{$env.TG_BOT_TOKEN}}/{{ $json.method || 'sendMessage' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.payload}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2384,
        2128
      ],
      "id": "87504dc6-d34a-4211-a09c-70d39a1079d6",
      "name": "HTTP Send \u2192 Customer (sendMessage)1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "64d9e91a-63c8-45a3-95f9-6e9c199ae228",
              "leftValue": "={{ $json.is_open === true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3040,
        2064
      ],
      "id": "261a544a-0424-42cf-a0d1-a1b30d0b0f36",
      "name": "IF: Kitchen is open?"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Ensure Cart Rows (approve)\n * Validates that we actually loaded cart lines for the ref.\n * Output 0: pass-through rows for downstream processing.\n * Output 1: admin notification when nothing to update.\n */\n\nconst rows = [];\nfor (const item of $input.all()) {\n  const json = item && typeof item.json === 'object' && item.json !== null ? item.json : null;\n  if (!json) {\n    continue;\n  }\n  const rowNum = Number(json.row_number);\n  if (Number.isFinite(rowNum) && rowNum > 0) {\n    rows.push({ ...json });\n  }\n}\n\nconst ctxItems = $items('Extract Admin Action') || [];\nconst ctx = ctxItems.length ? (ctxItems[0].json || {}) : {};\nconst adminChatId = String(ctx.admin_chat_id || '').trim();\nconst ref = String(ctx.ref || '').trim();\n\nif (!rows.length) {\n  if (adminChatId) {\n    const text = [\n      '\u26a0\ufe0f *No cart lines found*',\n      ref ? `Ref: *${ref}*` : '',\n      '',\n      'Nothing to update. The order may already be handled or the sheet entry is missing.',\n    ].filter(Boolean).join('\\n');\n\n    return [\n      [],\n      [{\n        json: {\n          method: 'sendMessage',\n          payload: {\n            chat_id: adminChatId,\n            text,\n            parse_mode: 'Markdown',\n          },\n        },\n      }],\n    ];\n  }\n  return [\n    [],\n    [],\n  ];\n}\n\nreturn [\n  rows.map(r => ({ json: r })),\n  [],\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2720,
        3632
      ],
      "id": "93df92b3-1ded-4327-b154-cf6865ca8797",
      "name": "Ensure Cart Rows (approve)"
    }
  ],
  "pinData": {
    "Telegram Trigger": [
      {
        "json": {
          "update_id": 933423085,
          "callback_query": {
            "id": "4924864824357942090",
            "from": {
              "id": 5441626742,
              "is_bot": false,
              "first_name": "Jon",
              "username": "Joni841",
              "language_code": "en"
            },
            "message": {
              "message_id": 2524,
              "from": {
                "id": 8293686289,
                "is_bot": true,
                "first_name": "Sefake Kitchen",
                "username": "SefakeKitchenBot"
              },
              "chat": {
                "id": 5441626742,
                "first_name": "Jon",
                "username": "Joni841",
                "type": "private"
              },
              "date": 1758747357,
              "text": "\ud83d\udc4b Welcome to Sefake Kitchen!\nOrder delicious meals via Telegram.\n\n\u2022 Tap Menu to start an order\n\u2022 Already have a cart? Tap Checkout\n\u2022 MoMo: 024XXXXXXX",
              "entities": [
                {
                  "offset": 14,
                  "length": 14,
                  "type": "bold"
                },
                {
                  "offset": 73,
                  "length": 4,
                  "type": "bold"
                },
                {
                  "offset": 123,
                  "length": 8,
                  "type": "bold"
                }
              ],
              "reply_markup": {
                "inline_keyboard": [
                  [
                    {
                      "text": "\ud83d\udcd6 Menu",
                      "callback_data": "MENU|OPEN"
                    }
                  ],
                  [
                    {
                      "text": "\ud83e\uddfe Checkout",
                      "callback_data": "CART|CHECKOUT"
                    }
                  ]
                ]
              }
            },
            "chat_instance": "-5632903552296079870",
            "data": "MENU|OPEN"
          }
        }
      }
    ]
  },
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Normalize Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize Event": {
      "main": [
        [
          {
            "node": "Build Customer Upsert",
            "type": "main",
            "index": 0
          },
          {
            "node": "GS: Read State",
            "type": "main",
            "index": 0
          },
          {
            "node": "Parse Callback",
            "type": "main",
            "index": 0
          },
          {
            "node": "GS: Read State (phone)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Customer Upsert": {
      "main": [
        [
          {
            "node": "GS: Read Customer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read Customer": {
      "main": [
        [
          {
            "node": "Find Customer Row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Customer Row": {
      "main": [
        [
          {
            "node": "IF Customer Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Customer Exists?": {
      "main": [
        [
          {
            "node": "Update Customer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Append Customer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read State": {
      "main": [
        [
          {
            "node": "Guard: Skip Channel IDs4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find/Init State": {
      "main": [
        [
          {
            "node": "IF State Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF State Exists?": {
      "main": [
        [],
        [
          {
            "node": "Guard: Skip Channel IDs3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Callback": {
      "main": [
        [
          {
            "node": "PAY|CONFIRM?",
            "type": "main",
            "index": 0
          },
          {
            "node": "ADMIN?",
            "type": "main",
            "index": 0
          },
          {
            "node": "IF: Is Greeting?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guard: Kitchen Open?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Action Router": {
      "main": [
        [
          {
            "node": "GS: Read Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GS: Read Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GS: Read State (phone)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GS: Read Menu (add)",
            "type": "main",
            "index": 0
          },
          {
            "node": "GS: Read Cart (add)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Ack? (safe)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GS: Read Cart (view)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GS: Read Cart (clear)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GS: Read Cart (checkout)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GS: Read Menu(details)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ack? (safe)1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Pickup Context",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ack? (safe)2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ack? (safe)3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ack?(safe)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Default Menu Page",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GS: Read Cart (clear)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reply: Contact Support",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read Menu": {
      "main": [
        [
          {
            "node": "Build Menu Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Menu Reply": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Default Menu Page": {
      "main": [
        [
          {
            "node": "GS: Read Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Dish Details": {
      "main": [
        [
          {
            "node": "HTTP Request (details)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read Menu(details)": {
      "main": [
        [
          {
            "node": "Build Dish Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pick Menu Item (by SKU)": {
      "main": [
        [
          {
            "node": "guard IF \u2013 invalid syntax",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Existing Cart Line": {
      "main": [
        [
          {
            "node": "IF Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Exists?": {
      "main": [
        [
          {
            "node": "Bump Qty",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GS: Append Cart Line",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Append Cart Line": {
      "main": [
        [
          {
            "node": "IF Has Dupes?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Cart Summary": {
      "main": [
        [
          {
            "node": "Send Cart",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read Cart (view)": {
      "main": [
        [
          {
            "node": "Build Cart Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read Cart (clear)": {
      "main": [
        [
          {
            "node": "Collect Rows To Delete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Collect Rows To Delete": {
      "main": [
        [
          {
            "node": "IF Nothing To Delete?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Nothing To Delete?": {
      "main": [
        [
          {
            "node": "Carry Chat (clear)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Split In Batches (1)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split In Batches (1)": {
      "main": [
        [
          {
            "node": "Carry Chat (clear)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GS: Delete Row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Delete Row": {
      "main": [
        [
          {
            "node": "Split In Batches (1)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read Cart (add)": {
      "main": [
        []
      ]
    },
    "GS: Read Menu (add)": {
      "main": [
        [
          {
            "node": "Pick Menu Item (by SKU)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Has Dupes?": {
      "main": [
        [
          {
            "node": "Make Dupe Items",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "GS: Delete Row (Row Number = {{$json.row_number}})",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ack Added": {
      "main": [
        []
      ]
    },
    "Make Dupe Items": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Delete Row (Row Number = {{$json.row_number}})": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Carry Chat (clear)": {
      "main": [
        [
          {
            "node": "Send Cleared",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Checkout Summary": {
      "main": [
        [
          {
            "node": "HTTP Request (sendMessage)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read Cart (checkout)": {
      "main": [
        [
          {
            "node": "Attach State \u2192 Lines (checkout)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Append State (pickup)": {
      "main": [
        []
      ]
    },
    "GS: Read State(delivery)": {
      "main": [
        [
          {
            "node": "Has State?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ack? (safe)": {
      "main": [
        [
          {
            "node": "Ack Added",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read State (phone)": {
      "main": [
        [
          {
            "node": "IF: Awaiting PHONE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Phone?": {
      "main": [
        [
          {
            "node": "Validate Ghana Phone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Ghana Phone": {
      "main": [
        [
          {
            "node": "IF \u2014 is phone valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF \u2014 is phone valid?": {
      "main": [
        [
          {
            "node": "GS: Save Phone",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reply: Invalid Phone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply: Invalid Phone": {
      "main": [
        [
          {
            "node": "HTTP: Send Invalid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP: Send Invalid": {
      "main": [
        [
          {
            "node": "GS: Keep Await Phone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Save Phone": {
      "main": [
        [
          {
            "node": "IF: Fulfillment is delivery?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply: Ask Address": {
      "main": [
        [
          {
            "node": "HTTP: Send Ask Address",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Delivery Context": {
      "main": [
        [
          {
            "node": "GS: Update State (delivery)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ask For Phone": {
      "main": [
        [
          {
            "node": "HTTP: Send Ask Phone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ack? (safe)1": {
      "main": [
        [
          {
            "node": "GS: Read State(delivery)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Has State?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has State?": {
      "main": [
        [
          {
            "node": "IF State Exists?3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF State Exists?3": {
      "main": [
        [
          {
            "node": "Set Delivery Context",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Delivery Context (create)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ask For Phone1": {
      "main": [
        [
          {
            "node": "HTTP: Send Ask Phone1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Append State (delivery)1": {
      "main": [
        [
          {
            "node": "Ask For Phone1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Delivery Context (create)": {
      "main": [
        [
          {
            "node": "GS: Append State (delivery)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Address?": {
      "main": [
        [
          {
            "node": "Find Zone",
            "type": "main",
            "index": 0
          },
          {
            "node": "GS: Read Zones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Zone": {
      "main": [
        [
          {
            "node": "IF Zone Found?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Zone Found?": {
      "main": [
        [
          {
            "node": "GS: Update State (address)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reply: Zone Not Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Update State (address)": {
      "main": [
        [
          {
            "node": "Reply: Address OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply: Address OK": {
      "main": [
        [
          {
            "node": "HTTP: Send Address OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply: Zone Not Found": {
      "main": [
        [
          {
            "node": "HTTP: Send Zone Not Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Update State (delivery)1": {
      "main": [
        [
          {
            "node": "Ask For Phone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Await Address (code)": {
      "main": [
        [
          {
            "node": "Update row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ack? (safe)2": {
      "main": [
        [
          {
            "node": "Set Await Address (code)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update row in sheet": {
      "main": [
        [
          {
            "node": "Reply: Ask Address",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ack? (safe)3": {
      "main": [
        [
          {
            "node": "GS: Read Cart",
            "type": "main",
            "index": 0
          },
          {
            "node": "GS: Read State1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read Cart": {
      "main": [
        [
          {
            "node": "filter Cart",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "filter Cart": {
      "main": [
        [
          {
            "node": "Join: Cart+State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Checkout Summary (code)": {
      "main": [
        [
          {
            "node": "HTTP: Send Checkout Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read State1": {
      "main": [
        [
          {
            "node": "Join: Cart+State",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Join: Cart+State": {
      "main": [
        [
          {
            "node": "Build Checkout Summary (code)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ack?(safe)": {
      "main": [
        [
          {
            "node": "GS: Read Cart1",
            "type": "main",
            "index": 0
          },
          {
            "node": "GS: Read State (UserStates)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read Cart1": {
      "main": [
        [
          {
            "node": "filter Cart (qty>0)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read State (UserStates)": {
      "main": [
        [
          {
            "node": "Ensure Order Number",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Line Updates": {
      "main": [
        [
          {
            "node": "GS: Update Lines (Orders)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Payment Instructions": {
      "main": [
        [
          {
            "node": "HTTP: Send Payment Instructions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Update State (await_payment + LastOrderNumber)": {
      "main": [
        []
      ]
    },
    "Ensure Order Number": {
      "main": [
        [
          {
            "node": "Join: PayCard Inputs",
            "type": "main",
            "index": 1
          },
          {
            "node": "Join: Cart + OrderNo",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "GS: Update Lines (Orders)": {
      "main": [
        []
      ]
    },
    "filter Cart (qty>0)": {
      "main": [
        [
          {
            "node": "Join: Cart + OrderNo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Join: Cart + OrderNo": {
      "main": [
        [
          {
            "node": "Join: Cart + OrderNo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Join: PayCard Inputs": {
      "main": [
        [
          {
            "node": "Build Payment Instructions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PAY|CONFIRM?": {
      "main": [
        [
          {
            "node": "Extract PAY|CONFIRM Ref",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract PAY|CONFIRM Ref": {
      "main": [
        [
          {
            "node": "Answer Callback (immediate)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build Customer Processing Message",
            "type": "main",
            "index": 0
          },
          {
            "node": "GS: Read Cart (by ref) \u2014 REVIEW",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Callback (immediate)": {
      "main": [
        []
      ]
    },
    "Reply: Ref Not Found": {
      "main": [
        [
          {
            "node": "HTTP Send \u2192 CUSTOMER Ref Not Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Customer Processing Message": {
      "main": [
        [
          {
            "node": "HTTP Send \u2192 Customer Processing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: OrderNumber matches ref (IF)": {
      "main": [
        [
          {
            "node": "Aggregate Lines & Totals",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Lines & Totals": {
      "main": [
        [
          {
            "node": "If: any lines?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read Orders (by ref)": {
      "main": [
        [
          {
            "node": "IF: Has Order row?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Freeze Updates": {
      "main": [
        [
          {
            "node": "GS: Update Cart Lines",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Update Cart Lines": {
      "main": [
        []
      ]
    },
    "GS: Update UserStates (mark paid)": {
      "main": [
        []
      ]
    },
    "IF: Has Order row?": {
      "main": [
        [
          {
            "node": "Attach Delivery Fee",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reply: Ref Not Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Update Orders (mark paid)": {
      "main": [
        []
      ]
    },
    "Build Kitchen Message": {
      "main": [
        [
          {
            "node": "HTTP Send \u2192 Kitchen Paid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Attach Delivery Fee": {
      "main": [
        [
          {
            "node": "Build Admin Review Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Customer Ack": {
      "main": [
        [
          {
            "node": "HTTP Send \u2192 Customer Paid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ADMIN?": {
      "main": [
        [
          {
            "node": "Extract Admin Action",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Admin Action(Reject)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Admin Action": {
      "main": [
        [
          {
            "node": "Answer Admin Callback",
            "type": "main",
            "index": 0
          },
          {
            "node": "GS: Read Cart (by ref) \u2014 APPROVE",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guard: Already Paid?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guard: Skip Channel IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Admin Callback": {
      "main": [
        [
          {
            "node": "HTTP: Telegram Send",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Admin Review Message": {
      "main": [
        [
          {
            "node": "HTTP Send \u2192 Admin Review",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Update UserStates (reject)": {
      "main": [
        []
      ]
    },
    "Notify Customer (rejected)": {
      "main": [
        [
          {
            "node": "HTTP Send \u2192 Customer Reject",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guard: Already Paid?": {
      "main": [
        [
          {
            "node": "Build Freeze Updates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read UserStates (by chat_id)": {
      "main": [
        [
          {
            "node": "Guard: Already Paid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read Cart (by ref) \u2014 REVIEW": {
      "main": [
        [
          {
            "node": "IF: OrderNumber matches ref (IF)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read Cart (by ref) \u2014 APPROVE": {
      "main": [
        [
          {
            "node": "Ensure Cart Rows (approve)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guard: Skip Channel IDs": {
      "main": [
        [
          {
            "node": "GS: Read UserStates (by chat_id)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guard: Skip Channel IDs1": {
      "main": [
        [
          {
            "node": "GS: Update UserStates (mark paid)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guard: Skip Channel IDs2": {
      "main": [
        [
          {
            "node": "Build UserState Reject Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guard: Skip Channel IDs3": {
      "main": [
        [
          {
            "node": "Append State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guard: Skip Channel IDs4": {
      "main": [
        [
          {
            "node": "Find/Init State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Lines & Totals \u2014 APPROVE": {
      "main": [
        [
          {
            "node": "GS: Read Orders (by ref)-Approve",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge (agg + order)",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "GS: Read Orders (by ref)-Approve": {
      "main": [
        [
          {
            "node": "Merge (agg + order)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Attach Delivery Fee \u2014 APPROVE": {
      "main": [
        [
          {
            "node": "Build Customer Ack",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build Kitchen Message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guard: Skip Channel IDs1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare Line Updates (approve)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge (agg + order)": {
      "main": [
        [
          {
            "node": "Attach Delivery Fee \u2014 APPROVE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Reject Updates (cart lines)": {
      "main": [
        [
          {
            "node": "GS: Update Cart Lines1",
            "type": "main",
            "index": 0
          },
          {
            "node": "IF: Has Rejectable Lines?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP: Telegram Send",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build UserState Reject Update": {
      "main": [
        [
          {
            "node": "GS: Update UserStates (reject)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read Cart (by ref) \u2014 REJECT": {
      "main": [
        [
          {
            "node": "Build Reject Updates (cart lines)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read UserStates (by chat_id)2": {
      "main": [
        [
          {
            "node": "Guard: Skip Channel IDs2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Admin Action(Reject)": {
      "main": [
        [
          {
            "node": "GS: Read UserStates (by chat_id)2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Guard: Already Reviewed?",
            "type": "main",
            "index": 0
          },
          {
            "node": "GS: Read Cart (by ref) \u2014 REJECT",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Admin Callback (spinner off)": {
      "main": [
        []
      ]
    },
    "Guard: Already Reviewed?": {
      "main": [
        [
          {
            "node": "Answer Admin Callback (spinner off)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply: Contact Support": {
      "main": [
        [
          {
            "node": "HTTP: Send (customer)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Pickup Context": {
      "main": [
        [
          {
            "node": "Reply: Pickup \u2192 Ask Phone",
            "type": "main",
            "index": 0
          },
          {
            "node": "Append or update row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Update UserStates (pickup)": {
      "main": [
        []
      ]
    },
    "IF: Fulfillment is delivery?": {
      "main": [
        [
          {
            "node": "Reply: Ask Address",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GS: Read State (summary)",
            "type": "main",
            "index": 0
          },
          {
            "node": "GS: Read Cart (checkout)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply: Pickup \u2192 Ask Phone": {
      "main": [
        [
          {
            "node": "HTTP: Send (customer Pickup)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS: Read State (summary)": {
      "main": [
        [
          {
            "node": "Attach State \u2192 Lines (checkout)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Attach State \u2192 Lines (checkout)": {
      "main": [
        [
          {
            "node": "Build Checkout Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Append or update row in sheet": {
      "main": [
        [
          {
            "node": "GS: Update UserStates (pickup)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If: any lines?": {
      "main": [
        [
          {
            "node": "GS: Read Orders (by ref)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reply: Ref Not Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bump Qty": {
      "main": [
        [
          {
            "node": "GS: Update Cart Line",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "guard IF \u2013 invalid syntax": {
      "main": [
        [
          {
            "node": "Find Existing Cart Line",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Awaiting ADDRESS": {
      "main": [
        [],
        []
      ]
    },
    "IF: Awaiting PHONE": {
      "main": [
        [
          {
            "node": "Needs Phone?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF: Awaiting ADDRESS",
            "type": "main",
            "index": 0
          },
          {
            "node": "Needs Address?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Join: Cart + OrderNo1": {
      "main": [
        [
          {
            "node": "GS: Update State (await_payment + LastOrderNumber)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare Line Updates",
            "type": "main",
            "index": 0
          },
          {
            "node": "Join: PayCard Inputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Line Updates (approve)": {
      "main": [
        [
          {
            "node": "GS: Update Orders (mark paid)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Has Rejectable Lines?": {
      "main": [
        [
          {
            "node": "Notify Customer (rejected)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Is Greeting?": {
      "main": [
        [
          {
            "node": "Action Router",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build Greeting",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guard: Kitchen Open?": {
      "main": [
        [
          {
            "node": "IF: Kitchen is open?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Greeting": {
      "main": [
        [
          {
            "node": "HTTP Send \u2192 Customer (sendMessage)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Closed Message": {
      "main": [
        [
          {
            "node": "HTTP Send \u2192 Customer (sendMessage)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Kitchen is open?": {
      "main": [
        [
          {
            "node": "Action Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Closed Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ensure Cart Rows (approve)": {
      "main": [
        [
          {
            "node": "Aggregate Lines & Totals \u2014 APPROVE",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build Freeze Updates",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP: Telegram Send",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "466e8e60-57fa-4204-8719-f03b11bfefb9",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9406bb58f60cf25428813fd7e451d41fa5e249d5d2f9c82aadc7e882245c5c23"
  },
  "id": "ySP9ldmZ4QTyzmsS",
  "tags": []
}